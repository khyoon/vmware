<!DOCTYPE HTML>
<html lang="ko" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Protect VDI via NSX Micro-Segmentation - khyoon&#x27;s VMware Note</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../vmware.html"><strong aria-hidden="true">1.</strong> VMware</a></li><li class="chapter-item expanded "><a href="../../vsphere/index.html"><strong aria-hidden="true">2.</strong> vSphere</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vsphere/vcenter/index.html"><strong aria-hidden="true">2.1.</strong> vCenter</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vsphere/vcenter/installation.html"><strong aria-hidden="true">2.1.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vsphere/esxi/index.html"><strong aria-hidden="true">2.2.</strong> ESXi</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vsphere/esxi/installation.html"><strong aria-hidden="true">2.2.1.</strong> Installation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/index.html"><strong aria-hidden="true">3.</strong> VCN (Virtual Cloud Network)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/livefire/index.html"><strong aria-hidden="true">3.1.</strong> VCN Livefie 1.0</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/livefire/kicking-things-off.html"><strong aria-hidden="true">3.1.1.</strong> Kicking Things Off</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/horizon-client-invalid-ssl-certificate.html"><strong aria-hidden="true">3.1.2.</strong> Horizon Client: Invalid SSL Certificate?</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/uctilise-terraform-to-apply-edge-firewall-rules.html"><strong aria-hidden="true">3.1.3.</strong> Utilise Terraform To Apply Edge Firewall Rules</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/enable-nsx-intrusion-prevention-system.html"><strong aria-hidden="true">3.1.4.</strong> Enable NSX Intrusion Prevention System (IDS)</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/perform-multi-stage-attack-leveraging-software-vulnerabilities.html"><strong aria-hidden="true">3.1.5.</strong> Perform Multi-Stage Attack Leveraging Software Vulnerabilities</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/use-nsx-ips-to-stop-attacks-to-vulnerable-applications.html"><strong aria-hidden="true">3.1.6.</strong> Use NSX IPS to Stop Attacks to Vulnerable Applications</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/protect-vdi-via-nsx-micro-segmentation.html" class="active"><strong aria-hidden="true">3.1.7.</strong> Protect VDI via NSX Micro-Segmentation</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/lab-introduction-and-overview.html"><strong aria-hidden="true">3.1.8.</strong> Lab Introduction and Overview</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-t-cloud-preparations.html"><strong aria-hidden="true">3.1.9.</strong> NSX-T Cloud Preparations</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/setup-nsx-t-cloud.html"><strong aria-hidden="true">3.1.10.</strong> Setup NSX-T Cloud</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/replace-existing-load-balancer.html"><strong aria-hidden="true">3.1.11.</strong> Replace existing Load Balancer</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/optional-service-optimization-and-operations.html"><strong aria-hidden="true">3.1.12.</strong> Optional: Service Optimization and Operations</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/lab-introduction.html"><strong aria-hidden="true">3.1.13.</strong> Lab Introduction</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-advanced-load-balancer-cloud-preparation.html"><strong aria-hidden="true">3.1.14.</strong> NSX Advanced Load Balancer Cloud preparation</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/avi-kubernetes-operator-for-tkg.html"><strong aria-hidden="true">3.1.15.</strong> Avi Kubernetes Operator for TKG</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/tkg-workload-l4-load-balancing.html"><strong aria-hidden="true">3.1.16.</strong> TKG Workload L4 load Balancing</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/tkg-workload-l7-load-balancing.html"><strong aria-hidden="true">3.1.17.</strong> TKG Workload L7 Load Balancing</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/tkg-workload-security-with-antrea-networkPolicy.html"><strong aria-hidden="true">3.1.18.</strong> TKG Workload Security with Antrea NetworkPolicy</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-cloud-environment-overview.html"><strong aria-hidden="true">3.1.19.</strong> NSX Cloud Environment Overview</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/validate-csm-registration-with-nsx-manager.html"><strong aria-hidden="true">3.1.20.</strong> Validate CSM Registration with NSX Manager</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/enable-csm-to-access-your-aws-inventory.html"><strong aria-hidden="true">3.1.21.</strong> Enable CSM to access your AWS inventory</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-enforced-mode-prepare-workloads.html"><strong aria-hidden="true">3.1.22.</strong> NSX Enforced Mode - Prepare workloads in Self-Managed/Transit AWS VPC</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-enforced-mode-deploy-nsx-pcg.html"><strong aria-hidden="true">3.1.23.</strong> NSX Enforced Mode - Deploy NSX PCG in a Self-Managed/Transit VPC</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-enforced-mode-onboard-workload-vms.html"><strong aria-hidden="true">3.1.24.</strong> NSX-Enforced Mode - Onboard Workload VMs</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-enforced-mode-connect-on-premise-dc-with-aws-vpc-leveraging-ipsec-vpn.html"><strong aria-hidden="true">3.1.25.</strong> NSX Enforced mode - Connect on-premise DC with AWS VPC leveraging IPSEC VPN</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-enforced-mode-setup-micro-segmentation-for-workloads.html"><strong aria-hidden="true">3.1.26.</strong> NSX Enforced Mode - Setup Micro-segmentation for workloads</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/onboarding-into-avi-load-balancer.html"><strong aria-hidden="true">3.1.27.</strong> Onboarding into AVI Load Balancer</a></li><li class="chapter-item expanded "><a href="../../vcn/livefire/nsx-enforced-mode-threat-detection-and-remediation-using-the-quarantine-policy.html"><strong aria-hidden="true">3.1.28.</strong> NSX Enforced Mode - Threat detection and remediation using the Quarantine policy</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx/index.html"><strong aria-hidden="true">3.2.</strong> NSX Data Center</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx/installation.html"><strong aria-hidden="true">3.2.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/sdwan/index.html"><strong aria-hidden="true">3.3.</strong> SD-WAN by VeloCloud</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/sdwan/installation.html"><strong aria-hidden="true">3.3.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx-alb/index.html"><strong aria-hidden="true">3.4.</strong> NSX Adv Load Balancer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx-alb/installation.html"><strong aria-hidden="true">3.4.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx-fw/index.html"><strong aria-hidden="true">3.5.</strong> NSX Service-defined Firewall</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx-fw/installation.html"><strong aria-hidden="true">3.5.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx-cloud/index.html"><strong aria-hidden="true">3.6.</strong> NSX Cloud</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx-cloud/installation.html"><strong aria-hidden="true">3.6.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx-int/index.html"><strong aria-hidden="true">3.7.</strong> NSX Intelligence</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx-int/installation.html"><strong aria-hidden="true">3.7.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/vrni/index.html"><strong aria-hidden="true">3.8.</strong> vRealize Network Insight</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/vrni/installation.html"><strong aria-hidden="true">3.8.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx-sm/index.html"><strong aria-hidden="true">3.9.</strong> NSX Service Mesh</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx-sm/installation.html"><strong aria-hidden="true">3.9.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/nsx-ids/index.html"><strong aria-hidden="true">3.10.</strong> NSX Distributed IDS/IPS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/nsx-ids/installation.html"><strong aria-hidden="true">3.10.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../../vcn/hcx/index.html"><strong aria-hidden="true">3.11.</strong> HCX</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../vcn/hcx/installation.html"><strong aria-hidden="true">3.11.1.</strong> Installation</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../about.html">about</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">khyoon&#x27;s VMware Note</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="24-protect-vdi-via-nsx-micro-segmentation-identity-firewall-l7-app-id-fqdn-based-firewall"><a class="header" href="#24-protect-vdi-via-nsx-micro-segmentation-identity-firewall-l7-app-id-fqdn-based-firewall">2.4 Protect VDI via NSX Micro-Segmentation (Identity Firewall, L7 APP-ID, FQDN based firewall)</a></h1>
<h2 id="1-overview"><a class="header" href="#1-overview">1. Overview</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/872/medium/2f8d0b03-1ce2-4541-b141-45b95fdf65bb.png" alt="" /></p>
<p>In this section, we will explore NSX advanced micro-segmentation capabilities in the context of a VDI use case. The first task will be securing the communication between a virtual desktop and the domain controller (deployed outside of the NSX control). This communication involves a variety of protocols and TCP and UDP ports. The initial configuration we will deploy via terraform includes a mix of L4 and L7 rules. We will tune the design to leverage more L7 rules to have stricter control on the traffic to and from the domain controller.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/048/870/medium/6298ac3f-6d26-45e5-aec1-a8f60802c687.png" alt="" /></p>
<p>The second section of this task will focus on Identity Firewall. NSX will allow access to specific URLs based on the identity of the user logged on the VDI. L7 rules will also control the TLS version the users are allowed to use.</p>
<h2 id="2-apply-vdi-micro-segmentation-policy-via-terraform"><a class="header" href="#2-apply-vdi-micro-segmentation-policy-via-terraform">2. Apply VDI Micro-segmentation Policy via Terraform</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/997/664/original/868ceebd-d007-4625-97e0-07cdb741761f.png" alt="" /></p>
<p>SSH to <strong>ubuntu-utils</strong>. Credentials are livefire/VMware1!</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/950/original/bdf345e6-c92b-408d-b326-494485118be8.png" alt="" /></p>
<ol>
<li>Navigate to the terraform directory via the command <code>cd terraform</code></li>
<li>Copy the terraform file defining the VDI firewall policy from the repository directory to the terraform directory. Use the command: <code>cp ../vcnlivefire-v1/vdi_dfw.tf ./</code></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/997/662/medium/c2e7eee4-f6f2-4cf1-a822-4df8ca3c5559.png" alt="" /></p>
<p>Run the command <code>terraform apply</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/997/668/original/c96be469-86b9-4dfc-8693-03fa02cc3f2e.png" alt="" /></p>
<p>Type <strong>yes</strong> then press Enter to confirm the changes</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/031/medium/28d0934f-b1b2-446f-a9d3-44092f7752bb.png" alt="" /></p>
<p>The policy will appear in the <strong>ENVIRONMENT</strong> section of the distributed firewall</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/053/original/66c226e7-3365-419f-b2b3-566ea0284273.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/017/original/de996190-8bac-4937-bf8e-e29d19b728ca.png" alt="" /></p>
<p>Clicking on the settings icon for each L7 rule (Layer 7 rules are those with a context profile applied), you can see the log label we associated to each of them to easily parse the logs generated by the matching traffic</p>
<h2 id="3-enable-identity-firewall-on-cluster-01a"><a class="header" href="#3-enable-identity-firewall-on-cluster-01a">3. Enable Identity Firewall on Cluster-01a</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/027/medium/fd15e95a-b57f-4d99-9d22-23e7a4d000b6.png" alt="" /></p>
<p>You will see a banner saying &quot;<em>Identity Firewall is disabled. Rules containing groups with identity entities (e.g. AD groups), will not be enforced.</em>&quot; Click on <strong>Enable</strong>.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/049/original/295ef389-60d5-48c7-a5d5-1aee063bd2d8.png" alt="" /></p>
<ol>
<li>Toggle the switch to enable <strong>Identify Firewall Status</strong> globally</li>
<li>Navigate to the Identity Firewall Settings tab</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/029/original/3ebea8c9-559c-46fd-9ac2-c4327720ceab.png" alt="" /></p>
<ol>
<li>Enable Identity Firewall on <strong>Cluster-01a</strong></li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><strong>Note:</strong> It's worth going back and double checking the cluster configuration was saved. Sometimes this doesn't take effect.</p>
<h2 id="4-examine-active-directory-log-in-process"><a class="header" href="#4-examine-active-directory-log-in-process">4. Examine Active Directory Log In Process</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/023/original/423e3f0c-5820-46f6-9e2b-9a07a5f6bc1e.png" alt="" /></p>
<p>SSH to esx-02a and run the command <code>tail -f /var/log/dfwpktlogs.log | grep 'l7\|l4'</code> . We are grepping for the log labels for the active directory traffic between the VDI and the domain controller. Rules <strong>6233-6237</strong> in the screenshot above (Rules number in your lab may be different)</p>
<p><img src="https://media.screensteps.com/image_assets/assets/004/132/690/medium/4bfc28d3-3ad0-4715-a6e6-c878d13cc9e1.png" alt="" /></p>
<p>From the vSphere client, launch the web console for <strong>win10-01a</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/035/original/ed423cd4-7d23-4b24-80cf-acba113f310c.png" alt="" /></p>
<p>Click on <strong>Send Ctrl+Alt+Delete</strong> in the top right</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/039/original/a5020473-d06d-4592-a21d-a4230d638440.png" alt="" /></p>
<p>Sign in to the <strong>CORP</strong> domain with credentials <strong>olive/VMware1!</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/025/medium/9c0fec90-cc1c-4412-affb-619328bca2fb.png" alt="" /></p>
<ol>
<li>In the logs you can see some traffic that is correctly categorized as DCE_RPC and LDAP protocols</li>
<li>Also some traffic that is inspected by the Active Directory L7 rules but it does not match the application and then match the fall back L4 rule. In this case the traffic on port 88 is Kerberos traffic.</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/045/original/fc2f3398-75fa-4aa7-94f2-39873057b6ed.png" alt="" /></p>
<p>On the VDI VM console:</p>
<ol>
<li>Click on the <strong>Windows</strong> button</li>
<li><strong>Olive</strong></li>
<li><strong>Sign Out</strong></li>
</ol>
<h2 id="5-add-a-l7-kerberos-rule"><a class="header" href="#5-add-a-l7-kerberos-rule">5. Add a L7 Kerberos Rule</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/021/medium/603a6ddf-85bf-4b3d-a847-f7ed9f49beb6.png" alt="" /></p>
<p>In the NSX Distributed Firewall UI:</p>
<ol>
<li>Select the <strong>LDAP rule</strong></li>
<li>Click <strong>CLONE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/033/medium/71ab6781-8f90-492f-9c42-de0ef2ab311b.png" alt="" /></p>
<ol>
<li>Edit the name of the new policy to <strong>Allow Kerberos Traffic to/from domain controller L7</strong></li>
<li>Change the Services field to <strong>Kerberos</strong></li>
<li>Change the Context Profiles field to <strong>Kerberos</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/047/original/2fe850c1-3d74-41d4-97bd-58df8947f22e.png" alt="" /></p>
<p>Change the log labels to <strong>kerberos_l7</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/015/original/4b70134c-30ee-4db2-a112-ad485094d2b5.png" alt="" /></p>
<p>Publish the changes</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/051/original/67431f71-3e88-4cfd-b5d6-52af5a7eb93d.png" alt="" /></p>
<p>Log in to the VDI again as Olive</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/043/medium/891d8c05-7b3a-478f-9364-85e044965680.png" alt="" /></p>
<ol>
<li>In the logs we can see that traffic on TCP port 88 is correctly categorized as <strong>APP_KERBEROS</strong></li>
<li>There is still some traffic (i.e. <strong>TCP port 445</strong>) that is matching the layer4 rule. Additional fine tuning of the L7 Segmentation policy could be achieved creating a layer 7 rule for that traffic</li>
</ol>
<h2 id="6-test-ssl-version-enforcement"><a class="header" href="#6-test-ssl-version-enforcement">6. Test SSL version enforcement</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/004/206/959/original/dcb98d6d-9f5f-4824-bbdd-81ca27c450ed.png" alt="" /></p>
<p>On esx-02a grep the logs for the TLS pattern via the command: <code>tail -f /var/log/dfwpktlogs.log | grep 'TLS'</code></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/235/medium/4000150e-8984-439a-beb4-b765a66b0f9f.png" alt="" /></p>
<p>Navigate to <a href="https://tls-v1-2.badssl.com:1012/">https://tls-v1-2.badssl.com:1012/</a> and verify that it is accessible</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/233/medium/d83ae369-28a5-4c33-b935-294ff9afad0f.png" alt="" /></p>
<p>Navigate to <a href="https://tls-v1-2.badssl.com:1012/">https://tls-v1-0.badssl.com:1010/</a> and verify that it is <strong>NOT</strong> accessible</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/592/medium/b422e2e1-bb8b-4315-9fea-97fecdceeb34.png" alt="" /></p>
<p>Logs will show the allowed traffic (1) and the blocked traffic (2) based on the different SSL version in use.</p>
<h2 id="7-configure-fqdn-blocklist"><a class="header" href="#7-configure-fqdn-blocklist">7. Configure FQDN blocklist</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/613/medium/42348b1f-1b80-4b20-b865-442b2d36afe9.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>Inventory</strong> tab</li>
<li>Select <strong>Context Profiles</strong></li>
<li>Select the <strong>FQDNs</strong> tab</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/616/original/eb3950a6-b263-4674-b55d-d09d4499156d.png" alt="" /></p>
<ol>
<li>Click on <strong>ACTIONS</strong></li>
<li>Select <strong>Add FQDN</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/607/original/c59b6fe8-e0ff-4fb1-b4de-445927f30ccf.png" alt="" /></p>
<ol>
<li>Type <strong>*.badssl.com</strong> in the domain field</li>
<li>Click <strong>SAVE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/618/original/bde25288-db6c-4753-a689-2777270cf88b.png" alt="" /></p>
<ol>
<li>Select <strong>Context Profiles</strong></li>
<li>Click on <strong>ADD CONTEXT PROFILE</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/605/original/16019331-0b15-4410-929e-5be3c74d998b.png" alt="" /></p>
<ol>
<li>Type <strong>BADSSL</strong> in the Name field</li>
<li>Click on <strong>SET</strong> to edit the Attributes</li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/584/original/ea858c63-b412-431c-a40c-ad0dd85ce7a2.png" alt="" /></p>
<ol>
<li>Click on <strong>ADD ATTRIBUTE</strong></li>
<li>Select <strong>Domain(FQDN) Name</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/614/original/ace5295c-9052-42bc-b09e-04dd9b6a38e3.png" alt="" /></p>
<ol>
<li>Select the <strong>*.badssl.com</strong> domain you created</li>
<li>Click <strong>ADD</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/603/medium/1cb55d4d-ee44-410f-8aeb-b73bd7184dab.png" alt="" /></p>
<p>Click <strong>APPLY</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/582/original/12da1ec6-4ed7-4879-9c26-76fe96988db2.png" alt="" /></p>
<p>Click <strong>SAVE</strong></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/593/medium/d0c7397f-3f56-4d90-9d6b-d106ff8740d5.png" alt="" /></p>
<ol>
<li>Navigate to the <strong>Security</strong> tab</li>
<li>Select <strong>Distributed Firewall</strong></li>
<li>Select the <strong>ENVIRONMENT</strong> category</li>
<li>Expand the <strong>vdi policy</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/577/medium/f0866fe4-043e-4615-b309-3df79dd81d42.png" alt="" /></p>
<p>Edit the Context Profiles field for the Identity Firewall Rules  </p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/598/medium/3fd99a8c-ac99-43f7-84f4-695636fe33ac.png" alt="" /></p>
<ol>
<li>Type <strong>badssl</strong> in the search bar</li>
<li>Select the <strong>BADSSL</strong> profile you created</li>
<li>Click <strong>APPLY</strong></li>
</ol>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/600/medium/71b9ca86-aea1-4e50-a341-de314b93e5d9.png" alt="" /></p>
<p>Click <strong>PUBLISH</strong></p>
<h2 id="a-hreftest-identity-firewall-enforcement-in-conjunction-with-fqdn-blockinga8-test-identity-firewall-enforcement-in-conjunction-with-fqdn-blocking"><a class="header" href="#a-hreftest-identity-firewall-enforcement-in-conjunction-with-fqdn-blockinga8-test-identity-firewall-enforcement-in-conjunction-with-fqdn-blocking"><a href="#test-identity-firewall-enforcement-in-conjunction-with-fqdn-blocking"></a>8. Test Identity Firewall Enforcement in conjunction with FQDN Blocking</a></h2>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/589/original/a6733f00-1d0c-4fe6-bde5-bcc9db96bd34.png" alt="" /></p>
<p>Grep the logs based on the 'exec' label via the command:  <code>tail -f /var/log/dfwpktlogs.log | grep 'exec'</code></p>
<p>Logs matching the Identity based rule will have the exec label</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/610/original/b0d7f48f-dc42-4047-af3b-6f27d1db26d8.png" alt="" /></p>
<p>Log in to the VDI desktop as the user <strong>pat</strong> this time (password VMware1!). No need to sign off the user olive.</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/580/medium/204ee92e-9247-4db2-baf3-0863e00ebccc.png" alt="" /></p>
<p>Navigate to <a href="https://tls-v1-2.badssl.com:1012/">https://tls-v1-2.badssl.com:1012/</a> and verify that it is <strong>NOT</strong> accessible for the user pat (It was for the user olive)</p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/595/medium/85e46111-ae87-476f-ae30-d944184833b7.png" alt="" /></p>
<p><img src="https://media.screensteps.com/image_assets/assets/003/998/586/original/21cc3155-2bb8-40be-a708-ec0b880fc8e4.png" alt="" /></p>
<p>Looking at the logs you can see the REJECT actions performed by the Identity Firewall rule</p>
<p>You can also see the matching based on the Active Directory Object Sid of the EXECS AD group the user pat is member of</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../vcn/livefire/use-nsx-ips-to-stop-attacks-to-vulnerable-applications.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../vcn/livefire/lab-introduction-and-overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../vcn/livefire/use-nsx-ips-to-stop-attacks-to-vulnerable-applications.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../vcn/livefire/lab-introduction-and-overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
